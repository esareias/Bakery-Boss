<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bakery Boss: Fraction Game</title>
    
    <!-- Tailwind CSS for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- React and ReactDOM -->
    <script type="importmap">
    {
      "imports": {
        "react": "https://esm.sh/react@18.2.0",
        "react-dom/client": "https://esm.sh/react-dom@18.2.0/client",
        "lucide-react": "https://esm.sh/lucide-react@0.263.1",
        "firebase/app": "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js",
        "firebase/auth": "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js",
        "firebase/firestore": "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js"
      }
    }
    </script>
    
    <style>
      /* Custom Animations */
      @keyframes float { 0% { transform: translateY(0px); } 50% { transform: translateY(-10px); } 100% { transform: translateY(0px); } }
      @keyframes shake { 10%, 90% { transform: translate3d(-1px, 0, 0); } 20%, 80% { transform: translate3d(2px, 0, 0); } 30%, 50%, 70% { transform: translate3d(-4px, 0, 0); } 40%, 60% { transform: translate3d(4px, 0, 0); } }
      @keyframes spin-slow { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
      @keyframes confetti { 
        0% { transform: translateY(0) rotate(0deg); opacity: 1; }
        100% { transform: translateY(100vh) rotate(720deg); opacity: 0; }
      }
      @keyframes sparkle {
        0% { transform: scale(0) rotate(0deg); opacity: 0; }
        50% { transform: scale(1) rotate(180deg); opacity: 1; }
        100% { transform: scale(0) rotate(360deg); opacity: 0; }
      }
      @keyframes bounce-happy {
        0%, 100% { transform: translateY(0) scale(1); }
        50% { transform: translateY(-20px) scale(1.1); }
      }
      @keyframes eat {
        0% { transform: scale(1); }
        50% { transform: scale(1.2) rotate(10deg); }
        100% { transform: scale(1); }
      }
      @keyframes wobble {
        0%, 100% { border-radius: 60% 40% 30% 70% / 60% 30% 70% 40%; }
        50% { border-radius: 30% 60% 70% 40% / 50% 60% 30% 60%; }
      }
      /* New Gentle Bounce Animation */
      @keyframes bounce-gentle { 
        0%, 100% { transform: translateY(0); } 
        50% { transform: translateY(-4px); } 
      }
      /* Snowfall Animation */
      @keyframes snowfall {
        0% { transform: translateY(-10vh) translateX(0) rotate(0deg); opacity: 0.8; }
        100% { transform: translateY(110vh) translateX(20px) rotate(360deg); opacity: 0.2; }
      }

      .animate-shake { animation: shake 0.5s cubic-bezier(.36,.07,.19,.97) both infinite; }
      .animate-spin-slow { animation: spin-slow 10s linear infinite; }
      .animate-confetti { animation-name: confetti; animation-timing-function: linear; animation-fill-mode: forwards; }
      .animate-sparkle { animation: sparkle 0.8s ease-in-out forwards; }
      .animate-bounce-happy { animation: bounce-happy 0.5s ease-in-out infinite; }
      .animate-eat { animation: eat 0.4s ease-in-out; }
      .animate-wobble { animation: wobble 3s ease-in-out infinite alternate; }
      .animate-bounce-gentle { animation: bounce-gentle 2s ease-in-out infinite; }
      .animate-snow { animation: snowfall linear infinite; }
      
      body { font-family: system-ui, -apple-system, sans-serif; }
    </style>
</head>
<body class="bg-slate-900 text-slate-100">
    <div id="root"></div>

    <script type="module">
        import React, { useState, useEffect, useRef } from 'react';
        import { createRoot } from 'react-dom/client';
        import { 
          PieChart, Divide, Grid, ArrowRight, RefreshCw, Trophy, Lock, Star, Gift, ShoppingBag, Palette, BookOpen, Scale, 
          ChefHat, CheckCircle, XCircle, Utensils, Coffee, Crown, Award, Gem, Zap, Heart, Sun, Moon, Smile, 
          ThumbsUp, Flag, Key, Bell, Lightbulb, Music, Camera, Anchor, Compass, MapPin, Flame, Hexagon, Shield, Target,
          Ghost, Skull, Eye, Monitor, Layers, Disc, Sparkles, Volume2, VolumeX, Brush, Cookie, Package, SkipForward,
          Settings, Download, Upload, Save, Rocket, Magnet, Glasses, Briefcase, Calculator, Cloud, Watch, FileText, Printer, Calendar, 
          Wand2, Sword, Hammer, Shirt, User, Home, Layout, Box, Wheat, Book, UtensilsCrossed, Snowflake
        } from 'lucide-react';
        
        import { initializeApp } from 'firebase/app';
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from 'firebase/auth';
        import { getFirestore, doc, onSnapshot, setDoc } from 'firebase/firestore';

        // ------------------------------------------------------------------
        // CONFIGURATION SECTION
        // ------------------------------------------------------------------
        
        let firebaseConfig;
        if (typeof __firebase_config !== 'undefined') {
            try { firebaseConfig = JSON.parse(__firebase_config); } catch (e) { console.warn("Could not parse env config"); }
        }
        if (!firebaseConfig) {
            firebaseConfig = { apiKey: "YOUR_API_KEY_HERE", authDomain: "test.firebaseapp.com", projectId: "test", storageBucket: "test.appspot.com", messagingSenderId: "12345", appId: "1:12345:web:12345" };
        }
        
        let app, auth, db;
        try {
            if (firebaseConfig.apiKey !== "YOUR_API_KEY_HERE") {
                app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);
            }
        } catch (e) { console.warn("Firebase Init Failed", e); }
        
        const appId = (typeof __app_id !== 'undefined') ? __app_id : 'fraction-bakery-final';
        
        const MUSIC_PLAYLIST = [
            { title: "Galaxy Theme", url: "https://codeskulptor-demos.commondatastorage.googleapis.com/GalaxyInvaders/theme_01.mp3" },
            { title: "Retro Race", url: "https://commondatastorage.googleapis.com/codeskulptor-assets/Epoq-Lepidoptera.ogg" },
            { title: "Pixel Bounce", url: "https://commondatastorage.googleapis.com/codeskulptor-assets/sounddogs/soundtrack.mp3" }
        ];

        // --- ASSETS & DATA ---
        
        const SvgPatterns = () => (
          React.createElement("svg", { width: "0", height: "0", className: "absolute opacity-0 pointer-events-none" },
            React.createElement("defs", null,
              React.createElement("filter", { id: "neonGlow", height: "300%", width: "300%", x: "-75%", y: "-75%" },
                React.createElement("feGaussianBlur", { stdDeviation: "2.5", result: "coloredBlur" }),
                React.createElement("feFlood", { floodColor: "#00E676", floodOpacity: "0.6", result: "neonColor" }),
                React.createElement("feComposite", { in: "neonColor", in2: "coloredBlur", operator: "in", result: "neonBlur" }),
                React.createElement("feMerge", null, React.createElement("feMergeNode", { in: "neonBlur" }), React.createElement("feMergeNode", { in: "SourceGraphic" }))
              ),
              React.createElement("filter", { id: "magmaGlow", height: "300%", width: "300%", x: "-75%", y: "-75%" },
                React.createElement("feGaussianBlur", { stdDeviation: "4", result: "blur" }),
                React.createElement("feFlood", { floodColor: "#FF3D00", floodOpacity: "0.7", result: "color" }),
                React.createElement("feComposite", { in: "color", in2: "blur", operator: "in", result: "shadow" }),
                React.createElement("feMerge", null, React.createElement("feMergeNode", { in: "shadow" }), React.createElement("feMergeNode", { in: "SourceGraphic" }))
              ),
              React.createElement("filter", { id: "goldMetal" },
                React.createElement("feSpecularLighting", { result: "specOut", specularExponent: "40", lightingColor: "#FFD700" }, React.createElement("fePointLight", { x: "50", y: "50", z: "60" })),
                React.createElement("feComposite", { in: "SourceGraphic", in2: "specOut", operator: "arithmetic", k1: "0", k2: "1", k3: "1", k4: "0" }),
                React.createElement("feDropShadow", { dx: "0", dy: "2", stdDeviation: "2", floodColor: "#B8860B", floodOpacity: "0.5" })
              ),
              React.createElement("filter", { id: "glitchFilter" },
                React.createElement("feTurbulence", { type: "fractalNoise", baseFrequency: "0.15", numOctaves: "1", result: "turbulence" }),
                React.createElement("feDisplacementMap", { in: "SourceGraphic", in2: "turbulence", scale: "5", xChannelSelector: "R", yChannelSelector: "G" })
              ),
              React.createElement("filter", { id: "softShadow" }, React.createElement("feDropShadow", { dx: "0", dy: "4", stdDeviation: "4", floodColor: "#000", floodOpacity: "0.2" })),
              
              // Patterns
              React.createElement("pattern", { id: "pizzaPattern", patternUnits: "objectBoundingBox", width: "1", height: "1", viewBox: "0 0 100 100", preserveAspectRatio: "none" },
                React.createElement("rect", { width: "100", height: "100", fill: "#FFD54F" }),
                React.createElement("circle", { cx: "20", cy: "20", r: "12", fill: "#D84315", opacity: "0.9" }),
                React.createElement("circle", { cx: "75", cy: "25", r: "11", fill: "#D84315", opacity: "0.9" }),
                React.createElement("circle", { cx: "50", cy: "60", r: "13", fill: "#D84315", opacity: "0.9" }),
                React.createElement("circle", { cx: "10", cy: "50", r: "2", fill: "#388E3C", opacity: "0.6" })
              ),
              React.createElement("radialGradient", { id: "cosmicGradient", cx: "50%", cy: "50%", r: "50%", fx: "50%", fy: "50%" },
                 React.createElement("stop", { offset: "0%", stopColor: "#7B1FA2" }),
                 React.createElement("stop", { offset: "60%", stopColor: "#311B92" }),
                 React.createElement("stop", { offset: "100%", stopColor: "#000000" })
              ),
              React.createElement("pattern", { id: "galaxyPattern", patternUnits: "objectBoundingBox", width: "1", height: "1", viewBox: "0 0 100 100", preserveAspectRatio: "none" },
                 React.createElement("rect", { width: "100", height: "100", fill: "url(#cosmicGradient)" }),
                 React.createElement("path", { d: "M 0 50 Q 50 0 100 50 T 0 50", stroke: "#F48FB1", strokeWidth: "30", fill: "none", opacity: "0.2", filter: "url(#softShadow)" }),
                 React.createElement("circle", { cx: "80", cy: "20", r: "15", fill: "#00E5FF", opacity: "0.3", filter: "url(#softShadow)" }),
                 React.createElement("circle", { cx: "10", cy: "10", r: "1", fill: "white" }),
                 React.createElement("circle", { cx: "90", cy: "90", r: "2", fill: "white" }),
                 React.createElement("circle", { cx: "50", cy: "50", r: "1", fill: "white" }),
                 React.createElement("circle", { cx: "70", cy: "60", r: "1.5", fill: "white", opacity: "0.8" })
              ),
              React.createElement("pattern", { id: "magmaPattern", patternUnits: "objectBoundingBox", width: "1", height: "1", viewBox: "0 0 100 100", preserveAspectRatio: "none" },
                 React.createElement("rect", { width: "100", height: "100", fill: "#210A00" }),
                 React.createElement("path", { d: "M 0 20 Q 30 50 60 20 T 100 40", stroke: "#FF3D00", strokeWidth: "8", fill: "none", filter: "url(#softShadow)" }),
                 React.createElement("path", { d: "M 0 80 Q 40 50 80 80 T 100 60", stroke: "#FF3D00", strokeWidth: "6", fill: "none", filter: "url(#softShadow)" }),
                 React.createElement("circle", { cx: "50", cy: "50", r: "15", fill: "#FF9100", opacity: "0.6", filter: "url(#softShadow)" })
              ),
              React.createElement("pattern", { id: "classicSponge", patternUnits: "objectBoundingBox", width: "1", height: "1", viewBox: "0 0 100 100", preserveAspectRatio: "none" },
                 React.createElement("rect", { width: "100", height: "100", fill: "#FCD34D" }),
                 React.createElement("circle", { cx: "20", cy: "20", r: "5", fill: "#F59E0B", opacity: "0.3" }),
                 React.createElement("circle", { cx: "70", cy: "80", r: "4", fill: "#FDE68A", opacity: "0.4" }),
                 React.createElement("circle", { cx: "50", cy: "50", r: "6", fill: "#F59E0B", opacity: "0.2" })
              ),
              React.createElement("pattern", { id: "chocoDeluxe", patternUnits: "objectBoundingBox", width: "1", height: "1", viewBox: "0 0 100 100", preserveAspectRatio: "none" },
                 React.createElement("rect", { width: "100", height: "100", fill: "#5D4037" }),
                 React.createElement("path", { d: "M 0 50 Q 50 0 100 50", stroke: "#8D6E63", strokeWidth: "8", fill: "none", opacity: "0.3" })
              ),
              React.createElement("pattern", { id: "berrySwirl", patternUnits: "objectBoundingBox", width: "1", height: "1", viewBox: "0 0 100 100", preserveAspectRatio: "none" },
                 React.createElement("rect", { width: "100", height: "100", fill: "#F48FB1" }),
                 React.createElement("circle", { cx: "10", cy: "10", r: "4", fill: "#C2185B", opacity: "0.4" }),
                 React.createElement("path", { d: "M 0 0 L 100 100", stroke: "#F8BBD0", strokeWidth: "2", opacity: "0.5" })
              ),
              React.createElement("pattern", { id: "mintPattern", patternUnits: "objectBoundingBox", width: "1", height: "1", viewBox: "0 0 100 100", preserveAspectRatio: "none" },
                 React.createElement("rect", { width: "100", height: "100", fill: "#A5D6A7" }),
                 React.createElement("rect", { x: "20", y: "20", width: "8", height: "8", fill: "#1B5E20", transform: "rotate(45 24 24)", opacity: "0.7" }),
                 React.createElement("rect", { x: "60", y: "60", width: "10", height: "10", fill: "#1B5E20", transform: "rotate(15 65 65)", opacity: "0.7" }),
                 React.createElement("rect", { x: "80", y: "20", width: "6", height: "6", fill: "#1B5E20", transform: "rotate(30 83 23)", opacity: "0.7" }),
                 React.createElement("rect", { x: "30", y: "80", width: "7", height: "7", fill: "#1B5E20", transform: "rotate(-10 33.5 83.5)", opacity: "0.7" })
              ),
              React.createElement("pattern", { id: "donutPattern", patternUnits: "objectBoundingBox", width: "1", height: "1", viewBox: "0 0 100 100", preserveAspectRatio: "none" },
                 React.createElement("rect", { width: "100", height: "100", fill: "#F8BBD0" }),
                 React.createElement("rect", { x: "10", y: "10", width: "4", height: "12", fill: "#42A5F5", rx: "2", transform: "rotate(30 12 16)" }),
                 React.createElement("rect", { x: "50", y: "20", width: "4", height: "12", fill: "#FFEE58", rx: "2", transform: "rotate(-15 52 26)" }),
                 React.createElement("rect", { x: "80", y: "60", width: "4", height: "12", fill: "#EF5350", rx: "2", transform: "rotate(45 82 66)" })
              ),
              React.createElement("pattern", { id: "cyberPattern", patternUnits: "objectBoundingBox", width: "0.1", height: "0.1", viewBox: "0 0 10 10" },
                 React.createElement("rect", { width: "10", height: "10", fill: "#121212" }),
                 React.createElement("path", { d: "M 0 5 L 10 5 M 5 0 L 5 10", stroke: "#00E676", strokeWidth: "0.2", opacity: "0.8" })
              ),
              React.createElement("pattern", { id: "glitchPattern", patternUnits: "objectBoundingBox", width: "0.2", height: "0.2", viewBox: "0 0 20 20" },
                 React.createElement("rect", { width: "20", height: "20", fill: "#000" }),
                 React.createElement("rect", { x: "0", y: "2", width: "20", height: "2", fill: "#0F0", opacity: "0.5" }),
                 React.createElement("rect", { x: "5", y: "10", width: "10", height: "2", fill: "#F0F", opacity: "0.5" })
              ),
              React.createElement("pattern", { id: "camoPattern", patternUnits: "objectBoundingBox", width: "1", height: "1", viewBox: "0 0 100 100", preserveAspectRatio: "none" },
                 React.createElement("rect", { width: "100", height: "100", fill: "#558B2F" }),
                 React.createElement("path", { d: "M 0 0 Q 30 60 60 0", fill: "#33691E", opacity: "0.8" }),
                 React.createElement("circle", { cx: "80", cy: "30", r: "15", fill: "#827717", opacity: "0.7" })
              ),
              React.createElement("pattern", { id: "zombiePattern", patternUnits: "objectBoundingBox", width: "1", height: "1", viewBox: "0 0 100 100", preserveAspectRatio: "none" },
                 React.createElement("rect", { width: "100", height: "100", fill: "#C6FF00" }),
                 React.createElement("path", { d: "M 0 0 L 100 0 L 100 40 Q 80 70 50 40 Q 20 70 0 40 Z", fill: "#76FF03", opacity: "0.5" }),
                 React.createElement("circle", { cx: "20", cy: "20", r: "8", fill: "#64DD17", opacity: "0.6" })
              ),
              React.createElement("linearGradient", { id: "goldGradient", x1: "0%", y1: "0%", x2: "100%", y2: "100%" },
                 React.createElement("stop", { offset: "0%", stopColor: "#FDB931" }),
                 React.createElement("stop", { offset: "50%", stopColor: "#FFD700" }),
                 React.createElement("stop", { offset: "100%", stopColor: "#FDB931" })
              ),
              React.createElement("linearGradient", { id: "rainbowGradient", x1: "0%", y1: "0%", x2: "100%", y2: "100%" },
                 React.createElement("stop", { offset: "0%", stopColor: "#FF0000" }),
                 React.createElement("stop", { offset: "20%", stopColor: "#FFFF00" }),
                 React.createElement("stop", { offset: "40%", stopColor: "#00FF00" }),
                 React.createElement("stop", { offset: "60%", stopColor: "#00FFFF" }),
                 React.createElement("stop", { offset: "80%", stopColor: "#0000FF" }),
                 React.createElement("stop", { offset: "100%", stopColor: "#FF00FF" })
              ),
              // NEW WINTER PATTERNS - FIXED WITH preserveAspectRatio="none"
              React.createElement("pattern", { id: "snowflakePattern", patternUnits: "objectBoundingBox", width: "0.25", height: "0.25", viewBox: "0 0 100 100", preserveAspectRatio: "none" },
                 React.createElement("rect", { width: "100", height: "100", fill: "#E1F5FE" }),
                 React.createElement("path", { d: "M50 20 L50 80 M20 50 L80 50 M30 30 L70 70 M30 70 L70 30", stroke: "#81D4FA", strokeWidth: "5", strokeLinecap: "round" }),
                 React.createElement("circle", { cx: "50", cy: "50", r: "5", fill: "#29B6F6" })
              ),
              React.createElement("pattern", { id: "ornamentPattern", patternUnits: "objectBoundingBox", width: "0.2", height: "0.2", viewBox: "0 0 100 100", preserveAspectRatio: "none" },
                 React.createElement("rect", { width: "100", height: "100", fill: "#2E7D32" }),
                 React.createElement("circle", { cx: "30", cy: "30", r: "15", fill: "#D32F2F" }), // Red
                 React.createElement("circle", { cx: "70", cy: "70", r: "12", fill: "#FFD700" }), // Gold
                 React.createElement("path", { d: "M0 0 L100 100", stroke: "#81C784", strokeWidth: "2", opacity: "0.3" })
              ),
              React.createElement("pattern", { id: "gingerPattern", patternUnits: "objectBoundingBox", width: "1", height: "1", viewBox: "0 0 100 100", preserveAspectRatio: "none" },
                 React.createElement("rect", { width: "100", height: "100", fill: "#8D6E63" }),
                 React.createElement("path", { d: "M 0 20 Q 25 0 50 20 T 100 20", stroke: "white", strokeWidth: "4", fill: "none" }),
                 React.createElement("path", { d: "M 0 80 Q 25 100 50 80 T 100 80", stroke: "white", strokeWidth: "4", fill: "none" }),
                 React.createElement("circle", { cx: "50", cy: "50", r: "5", fill: "#4CAF50" }), // Green button
                 React.createElement("circle", { cx: "50", cy: "65", r: "5", fill: "#F44336" })  // Red button
              ),
              React.createElement("pattern", { id: "candyCanePattern", patternUnits: "objectBoundingBox", width: "0.1", height: "0.1", viewBox: "0 0 20 20", preserveAspectRatio: "none", patternTransform: "rotate(45)" },
                 React.createElement("rect", { width: "20", height: "20", fill: "white" }),
                 React.createElement("rect", { width: "10", height: "20", fill: "#D32F2F" })
              ),
              React.createElement("radialGradient", { id: "nebulaGradient", cx: "50%", cy: "50%", r: "60%" },
                 React.createElement("stop", { offset: "0%", stopColor: "#F48FB1" }),
                 React.createElement("stop", { offset: "50%", stopColor: "#7B1FA2" }),
                 React.createElement("stop", { offset: "100%", stopColor: "#000000" })
              ),
              React.createElement("pattern", { id: "matrixPattern", patternUnits: "objectBoundingBox", width: "0.1", height: "0.1", viewBox: "0 0 10 10", preserveAspectRatio: "none" },
                 React.createElement("rect", { width: "10", height: "10", fill: "black" }),
                 React.createElement("text", { x: "2", y: "8", fill: "#00FF00", fontSize: "8", fontFamily: "monospace", opacity: "0.8" }, "1"),
                 React.createElement("text", { x: "6", y: "4", fill: "#00FF00", fontSize: "6", fontFamily: "monospace", opacity: "0.6" }, "0")
              ),
              React.createElement("pattern", { id: "icePattern", patternUnits: "objectBoundingBox", width: "1", height: "1", viewBox: "0 0 100 100", preserveAspectRatio: "none" },
                 React.createElement("rect", { width: "100", height: "100", fill: "#E0F7FA" }),
                 React.createElement("path", { d: "M 0 0 L 50 50 L 100 0", stroke: "white", strokeWidth: "5", fill: "none", opacity: "0.7" }),
                 React.createElement("path", { d: "M 0 100 L 50 50 L 100 100", stroke: "white", strokeWidth: "5", fill: "none", opacity: "0.7" })
              ),
              React.createElement("pattern", { id: "blueprintPattern", patternUnits: "objectBoundingBox", width: "0.1", height: "0.1", viewBox: "0 0 20 20", preserveAspectRatio: "none" },
                 React.createElement("rect", { width: "20", height: "20", fill: "#1565C0" }),
                 React.createElement("line", { x1: "0", y1: "10", x2: "20", y2: "10", stroke: "white", strokeWidth: "0.5", opacity: "0.5" }),
                 React.createElement("line", { x1: "10", y1: "0", x2: "10", y2: "20", stroke: "white", strokeWidth: "0.5", opacity: "0.5" })
              ),
              React.createElement("linearGradient", { id: "lightingOverlay", x1: "0%", y1: "0%", x2: "0%", y2: "100%" },
                 React.createElement("stop", { offset: "0%", stopColor: "white", stopOpacity: "0.4" }),
                 React.createElement("stop", { offset: "100%", stopColor: "black", stopOpacity: "0.1" })
              ),

              /* --- RESTORED MISSING PATTERNS (Common to Legend) --- */
              // 1. Vanilla
              React.createElement("pattern", { id: "vanillaPattern", patternUnits: "objectBoundingBox", width: "0.1", height: "0.1", viewBox: "0 0 10 10", preserveAspectRatio: "none" },
                 React.createElement("rect", { width: "10", height: "10", fill: "#FFF8E1" }), 
                 React.createElement("circle", { cx: "2", cy: "2", r: "0.2", fill: "#3E2723" }),
                 React.createElement("circle", { cx: "7", cy: "8", r: "0.2", fill: "#3E2723" }),
                 React.createElement("circle", { cx: "5", cy: "5", r: "0.3", fill: "#3E2723" })
              ),
              // 2. Citrus
              React.createElement("pattern", { id: "citrusPattern", patternUnits: "objectBoundingBox", width: "1", height: "1", viewBox: "0 0 100 100", preserveAspectRatio: "none" },
                 React.createElement("rect", { width: "100", height: "100", fill: "#FFF176" }),
                 React.createElement("circle", { cx: "20", cy: "20", r: "2", fill: "white", opacity: "0.5" }),
                 React.createElement("circle", { cx: "80", cy: "80", r: "3", fill: "white", opacity: "0.5" }),
                 React.createElement("path", { d: "M0 0 L100 100 M100 0 L0 100", stroke: "#FFEE58", strokeWidth: "1" })
              ),
              // 3. Melon
              React.createElement("pattern", { id: "melonPattern", patternUnits: "objectBoundingBox", width: "1", height: "1", viewBox: "0 0 100 100", preserveAspectRatio: "none" },
                 React.createElement("rect", { width: "100", height: "100", fill: "#F48FB1" }),
                 React.createElement("path", { d: "M 10 10 Q 15 20 10 30", stroke: "black", strokeWidth: "2", fill: "none", opacity: "0.8" }),
                 React.createElement("path", { d: "M 60 50 Q 65 60 60 70", stroke: "black", strokeWidth: "2", fill: "none", opacity: "0.8" }),
                 React.createElement("rect", { x: "0", y: "90", width: "100", height: "10", fill: "#66BB6A" })
              ),
              // 4. Bumble
              React.createElement("pattern", { id: "bumblePattern", patternUnits: "objectBoundingBox", width: "0.2", height: "0.2", viewBox: "0 0 20 20", preserveAspectRatio: "none", patternTransform: "rotate(45)" },
                 React.createElement("rect", { width: "20", height: "20", fill: "#FFD600" }),
                 React.createElement("rect", { width: "10", height: "20", fill: "#212121" })
              ),
              // 5. Denim
              React.createElement("pattern", { id: "denimPattern", patternUnits: "objectBoundingBox", width: "0.05", height: "0.05", viewBox: "0 0 10 10", preserveAspectRatio: "none" },
                 React.createElement("rect", { width: "10", height: "10", fill: "#1565C0" }),
                 React.createElement("path", { d: "M0 0 L10 10 M10 0 L0 10", stroke: "#90CAF9", strokeWidth: "0.5", opacity: "0.3" })
              ),
              // 6. Bubblegum (Pop Star)
              React.createElement("pattern", { id: "bubblePattern", patternUnits: "objectBoundingBox", width: "0.25", height: "0.25", viewBox: "0 0 100 100", preserveAspectRatio: "none" },
                 React.createElement("rect", { width: "100", height: "100", fill: "#F8BBD0" }),
                 React.createElement("circle", { cx: "50", cy: "50", r: "30", fill: "#F06292", opacity: "0.6" }),
                 React.createElement("circle", { cx: "20", cy: "20", r: "10", fill: "#29B6F6", opacity: "0.4" }),
                 React.createElement("circle", { cx: "55", cy: "45", r: "5", fill: "white", opacity: "0.8" })
              ),
              // 7. Dragon
              React.createElement("pattern", { id: "dragonPattern", patternUnits: "objectBoundingBox", width: "0.2", height: "0.2", viewBox: "0 0 100 100", preserveAspectRatio: "none" },
                 React.createElement("rect", { width: "100", height: "100", fill: "#1B5E20" }),
                 React.createElement("path", { d: "M50 100 Q0 50 50 0 Q100 50 50 100", fill: "#2E7D32", stroke: "#000", strokeWidth: "1" }),
                 React.createElement("path", { d: "M50 80 Q20 50 50 20 Q80 50 50 80", fill: "none", stroke: "#4CAF50", strokeWidth: "2" })
              ),
              // 8. Circuit
              React.createElement("pattern", { id: "circuitPattern", patternUnits: "objectBoundingBox", width: "0.2", height: "0.2", viewBox: "0 0 100 100", preserveAspectRatio: "none" },
                 React.createElement("rect", { width: "100", height: "100", fill: "#004D40" }),
                 React.createElement("path", { d: "M10 10 H50 V50 H90", fill: "none", stroke: "#FFD700", strokeWidth: "3" }),
                 React.createElement("circle", { cx: "10", cy: "10", r: "5", fill: "#FFD700" }),
                 React.createElement("circle", { cx: "90", cy: "50", r: "5", fill: "#FFD700" })
              ),

              /* --- RESTORED MYTHIC ANIMATED PATTERNS --- */
              // Hyperdrive
              React.createElement("pattern", { id: "hyperPattern", patternUnits: "objectBoundingBox", width: "1", height: "1", viewBox: "0 0 100 100", preserveAspectRatio: "none" },
                 React.createElement("rect", { width: "100", height: "100", fill: "black" }),
                 React.createElement("line", { x1: "50", y1: "50", x2: "50", y2: "0", stroke: "white", strokeWidth: "2", strokeLinecap: "round" },
                    React.createElement("animate", { attributeName: "y2", values: "50; 0; -50", dur: "1s", repeatCount: "indefinite" }),
                    React.createElement("animate", { attributeName: "opacity", values: "0; 1; 0", dur: "1s", repeatCount: "indefinite" })
                 ),
                 React.createElement("line", { x1: "50", y1: "50", x2: "100", y2: "50", stroke: "white", strokeWidth: "2", strokeLinecap: "round" },
                    React.createElement("animate", { attributeName: "x2", values: "50; 100; 150", dur: "1.2s", repeatCount: "indefinite" }),
                    React.createElement("animate", { attributeName: "opacity", values: "0; 1; 0", dur: "1.2s", repeatCount: "indefinite" })
                 ),
                 React.createElement("line", { x1: "50", y1: "50", x2: "0", y2: "100", stroke: "cyan", strokeWidth: "2", strokeLinecap: "round" },
                     React.createElement("animate", { attributeName: "x2", values: "50; 0; -50", dur: "0.8s", repeatCount: "indefinite" }),
                     React.createElement("animate", { attributeName: "y2", values: "50; 100; 150", dur: "0.8s", repeatCount: "indefinite" })
                 )
              ),
              // Aurora
              React.createElement("linearGradient", { id: "auroraGrad", x1: "0%", y1: "0%", x2: "100%", y2: "100%" },
                 React.createElement("stop", { offset: "0%", stopColor: "#00ff88" },
                    React.createElement("animate", { attributeName: "stop-color", values: "#00ff88; #00ffff; #00ff88", dur: "4s", repeatCount: "indefinite" })
                 ),
                 React.createElement("stop", { offset: "100%", stopColor: "#ff00ff" },
                    React.createElement("animate", { attributeName: "stop-color", values: "#ff00ff; #ffff00; #ff00ff", dur: "4s", repeatCount: "indefinite" })
                 )
              ),
              React.createElement("pattern", { id: "auroraPattern", patternUnits: "objectBoundingBox", width: "1", height: "1", viewBox: "0 0 100 100", preserveAspectRatio: "none" },
                  React.createElement("rect", { width: "100", height: "100", fill: "url(#auroraGrad)" }),
                  React.createElement("path", { d: "M0 50 Q50 20 100 50", fill: "none", stroke: "white", strokeWidth: "2", opacity: "0.3" },
                      React.createElement("animate", { attributeName: "d", values: "M0 50 Q50 20 100 50; M0 50 Q50 80 100 50; M0 50 Q50 20 100 50", dur: "6s", repeatCount: "indefinite" })
                  )
              ),
              // Plasma
              React.createElement("pattern", { id: "plasmaPattern", patternUnits: "objectBoundingBox", width: "1", height: "1", viewBox: "0 0 100 100", preserveAspectRatio: "none" },
                 React.createElement("rect", { width: "100", height: "100", fill: "#0D47A1" }),
                 React.createElement("path", { d: "M10 10 L30 40 L60 20 L90 80", fill: "none", stroke: "#00E5FF", strokeWidth: "3" },
                     React.createElement("animate", { attributeName: "stroke-opacity", values: "1;0.2;1", dur: "0.2s", repeatCount: "indefinite" }),
                     React.createElement("animate", { attributeName: "d", values: "M10 10 L30 40 L60 20 L90 80; M10 10 L40 30 L50 70 L90 80; M10 10 L30 40 L60 20 L90 80", dur: "0.5s", repeatCount: "indefinite" })
                 )
              ),
              // Void
              React.createElement("radialGradient", { id: "voidGrad", cx: "50%", cy: "50%", r: "50%" },
                  React.createElement("stop", { offset: "0%", stopColor: "black" }),
                  React.createElement("stop", { offset: "80%", stopColor: "#311B92" }),
                  React.createElement("stop", { offset: "100%", stopColor: "black" })
              ),
              React.createElement("pattern", { id: "voidPattern", patternUnits: "objectBoundingBox", width: "1", height: "1", viewBox: "0 0 100 100", preserveAspectRatio: "none" },
                  React.createElement("rect", { width: "100", height: "100", fill: "black" }),
                  React.createElement("circle", { cx: "50", cy: "50", r: "40", fill: "url(#voidGrad)" },
                      React.createElement("animate", { attributeName: "r", values: "40; 35; 40", dur: "3s", repeatCount: "indefinite" })
                  )
              ),
              // Biohazard
              React.createElement("pattern", { id: "bioPattern", patternUnits: "objectBoundingBox", width: "0.25", height: "0.25", viewBox: "0 0 100 100", preserveAspectRatio: "none" },
                  React.createElement("rect", { width: "100", height: "100", fill: "#1B5E20" }),
                  React.createElement("circle", { cx: "50", cy: "50", r: "20", fill: "#76FF03", opacity: "0.8" },
                      React.createElement("animate", { attributeName: "opacity", values: "0.8; 0.2; 0.8", dur: "1.5s", repeatCount: "indefinite" })
                  ),
                  React.createElement("circle", { cx: "50", cy: "50", r: "10", fill: "black" })
              ),
              // Prism
              React.createElement("pattern", { id: "prismPattern", patternUnits: "objectBoundingBox", width: "0.5", height: "0.5", viewBox: "0 0 100 100", preserveAspectRatio: "none" },
                  React.createElement("rect", { width: "100", height: "100", fill: "#ECEFF1" }),
                  React.createElement("g", { transform: "translate(50,50)" },
                      React.createElement("polygon", { points: "0,-30 25,15 -25,15", fill: "none", stroke: "cyan", strokeWidth: "2" },
                          React.createElement("animateTransform", { attributeName: "transform", type: "rotate", from: "0", to: "360", dur: "5s", repeatCount: "indefinite" })
                      ),
                       React.createElement("polygon", { points: "0,-20 17,10 -17,10", fill: "none", stroke: "magenta", strokeWidth: "2" },
                          React.createElement("animateTransform", { attributeName: "transform", type: "rotate", from: "360", to: "0", dur: "7s", repeatCount: "indefinite" })
                      )
                  )
              ),
              // Rune
              React.createElement("pattern", { id: "runePattern", patternUnits: "objectBoundingBox", width: "0.2", height: "0.2", viewBox: "0 0 100 100", preserveAspectRatio: "none" },
                  React.createElement("rect", { width: "100", height: "100", fill: "#263238" }),
                  React.createElement("text", { x: "20", y: "60", fill: "#00E5FF", fontSize: "40", fontFamily: "serif" }, "ᚠ",
                      React.createElement("animate", { attributeName: "opacity", values: "0;1;0", dur: "3s", repeatCount: "indefinite" })
                  )
              ),
              // Sonar
              React.createElement("pattern", { id: "sonarPattern", patternUnits: "objectBoundingBox", width: "1", height: "1", viewBox: "0 0 100 100", preserveAspectRatio: "none" },
                  React.createElement("rect", { width: "100", height: "100", fill: "#002b11" }),
                  React.createElement("circle", { cx: "50", cy: "50", r: "1", fill: "none", stroke: "#00FF00", strokeWidth: "2" },
                      React.createElement("animate", { attributeName: "r", from: "1", to: "50", dur: "2s", repeatCount: "indefinite" }),
                      React.createElement("animate", { attributeName: "opacity", from: "1", to: "0", dur: "2s", repeatCount: "indefinite" })
                  )
              ),
              // Spirit
              React.createElement("pattern", { id: "spiritPattern", patternUnits: "objectBoundingBox", width: "0.2", height: "0.2", viewBox: "0 0 100 100", preserveAspectRatio: "none" },
                  React.createElement("rect", { width: "100", height: "100", fill: "#455A64" }),
                  React.createElement("circle", { cx: "50", cy: "80", r: "10", fill: "#CFD8DC", opacity: "0.5" },
                      React.createElement("animate", { attributeName: "cy", from: "100", to: "0", dur: "3s", repeatCount: "indefinite" }),
                      React.createElement("animate", { attributeName: "opacity", values: "0;0.5;0", dur: "3s", repeatCount: "indefinite" })
                  )
              ),

              // Disco Pattern (Boogie Dough)
              React.createElement("pattern", { id: "discoPattern", patternUnits: "objectBoundingBox", width: "0.1", height: "0.1", viewBox: "0 0 10 10", preserveAspectRatio: "none" },
                 React.createElement("rect", { width: "10", height: "10", fill: "#E0E0E0" }),
                 React.createElement("rect", { x: "1", y: "1", width: "8", height: "8", fill: "#F5F5F5" }), 
                 React.createElement("path", { d: "M0 10 L10 0", stroke: "white", strokeWidth: "1", opacity: "0.8" })
              ),
              React.createElement("filter", { id: "discoGlow" },
                React.createElement("feGaussianBlur", { stdDeviation: "2", result: "blur" }),
                React.createElement("feComposite", { in: "SourceGraphic", in2: "blur", operator: "over" })
              ),

              // Chrono Pattern (Time Pet)
              React.createElement("pattern", { id: "chronoPattern", patternUnits: "objectBoundingBox", width: "0.5", height: "0.5", viewBox: "0 0 100 100", preserveAspectRatio: "none" },
                 React.createElement("rect", { width: "100", height: "100", fill: "#1a1a1a" }),
                 React.createElement("g", { transform: "translate(50,50)" },
                    React.createElement("path", { d: "M-15,-40 L15,-40 L15,-25 L35,-15 L45,-25 L60,-10 L50,5 L60,20 L45,35 L35,25 L15,35 L15,50 L-15,50 L-15,35 L-35,25 L-45,35 L-60,20 L-50,5 L-60,-10 L-45,-25 L-35,-15 L-15,-25 Z", fill: "none", stroke: "#FFD700", strokeWidth: "2" },
                        React.createElement("animateTransform", { attributeName: "transform", type: "rotate", from: "0", to: "360", dur: "10s", repeatCount: "indefinite" })
                    ),
                    React.createElement("circle", { r: "10", fill: "#FFD700", opacity: "0.5" })
                 )
              ),

              // Portal Pattern (Void Pet)
              React.createElement("radialGradient", { id: "portalGradient", cx: "50%", cy: "50%", r: "50%" },
                 React.createElement("stop", { offset: "0%", stopColor: "#000" }),
                 React.createElement("stop", { offset: "70%", stopColor: "#4A148C" }),
                 React.createElement("stop", { offset: "100%", stopColor: "#AA00FF" })
              ),
              React.createElement("pattern", { id: "portalPattern", patternUnits: "objectBoundingBox", width: "1", height: "1", viewBox: "0 0 100 100", preserveAspectRatio: "none" },
                 React.createElement("rect", { width: "100", height: "100", fill: "url(#portalGradient)" }),
                 React.createElement("path", { d: "M50 50 Q80 20 80 50 T50 80 T20 50 T50 20", fill: "none", stroke: "#E040FB", strokeWidth: "2", strokeDasharray: "5 5" },
                    React.createElement("animate", { attributeName: "stroke-dashoffset", from: "100", to: "0", dur: "5s", repeatCount: "indefinite" })
                 )
              )
            )
          )
        );

        // Snowfall Component
        const Snowfall = () => (
            React.createElement("div", { className: "fixed inset-0 pointer-events-none z-[1]" },
                Array.from({ length: 50 }).map((_, i) => 
                    React.createElement("div", {
                        key: i,
                        className: "absolute text-white animate-snow opacity-70",
                        style: {
                            left: `${Math.random() * 100}vw`,
                            top: `${Math.random() * -20}vh`,
                            animationDuration: `${Math.random() * 5 + 5}s`,
                            animationDelay: `${Math.random() * 5}s`,
                            fontSize: `${Math.random() * 10 + 10}px`,
                        }
                    }, "❄")
                )
            )
        );

        const THEMES = {
          classic: { id: 'classic', name: 'Classic Sponge', fill: 'url(#classicSponge)', stroke: '#B45309', side: '#D97706', bg: 'bg-amber-50', text: 'text-amber-900', rarity: 'common' },
          choco:   { id: 'choco', name: 'Double Fudge', fill: 'url(#chocoDeluxe)', stroke: '#3E2723', side: '#4E342E', bg: 'bg-stone-100', text: 'text-stone-800', rarity: 'common' },
          berry:   { id: 'berry', name: 'Berry Blast', fill: 'url(#berrySwirl)', stroke: '#880E4F', side: '#AD1457', bg: 'bg-pink-50', text: 'text-pink-900', rarity: 'common' },
          // NEW COMMON
          vanilla: { id: 'vanilla', name: 'French Vanilla', fill: 'url(#vanillaPattern)', stroke: '#5D4037', side: '#D7CCC8', bg: 'bg-orange-50', text: 'text-stone-600', rarity: 'common' },
          citrus:  { id: 'citrus', name: 'Lemon Zest', fill: 'url(#citrusPattern)', stroke: '#FBC02D', side: '#FFF59D', bg: 'bg-yellow-50', text: 'text-yellow-800', rarity: 'common' },
          
          pizza:   { id: 'pizza', name: 'Pepperoni', fill: 'url(#pizzaPattern)', stroke: '#BF360C', side: '#E65100', bg: 'bg-orange-50', text: 'text-orange-900', rarity: 'uncommon' },
          mint:    { id: 'mint', name: 'Mint Chip', fill: 'url(#mintPattern)', stroke: '#1B5E20', side: '#2E7D32', bg: 'bg-emerald-50', text: 'text-emerald-900', rarity: 'uncommon' },
          donut:   { id: 'donut', name: 'Sprinkle Donut', fill: 'url(#donutPattern)', stroke: '#C2185B', side: '#D81B60', bg: 'bg-pink-100', text: 'text-pink-800', rarity: 'uncommon' },
          honey:   { id: 'honey', name: 'Honeycomb', fill: '#FFEB3B', stroke: '#FBC02D', side: '#F57F17', bg: 'bg-yellow-50', text: 'text-yellow-900', rarity: 'uncommon' },
          // NEW UNCOMMON
          melon:   { id: 'melon', name: 'Watermelon', fill: 'url(#melonPattern)', stroke: '#1B5E20', side: '#2E7D32', bg: 'bg-green-50', text: 'text-pink-800', rarity: 'uncommon' },
          bumble:  { id: 'bumble', name: 'Busy Bee', fill: 'url(#bumblePattern)', stroke: 'black', side: '#FBC02D', bg: 'bg-yellow-100', text: 'text-black', rarity: 'uncommon' },

          frozen:  { id: 'frozen', name: 'Snowstorm', fill: 'url(#snowflakePattern)', stroke: '#0288D1', side: '#01579B', bg: 'bg-cyan-50', text: 'text-cyan-900', rarity: 'rare' },
          festive: { id: 'festive', name: 'Holiday Spirit', fill: 'url(#ornamentPattern)', stroke: '#1B5E20', side: '#004D40', bg: 'bg-green-100', text: 'text-green-900', rarity: 'rare' },
          ginger:  { id: 'ginger', name: 'Gingerbread', fill: 'url(#gingerPattern)', stroke: '#5D4037', side: '#3E2723', bg: 'bg-orange-50', text: 'text-orange-900', rarity: 'rare' },
          galaxy:  { id: 'galaxy', name: 'Cosmic', fill: 'url(#galaxyPattern)', stroke: '#311B92', side: '#4527A0', bg: 'bg-slate-900', text: 'text-purple-200', rarity: 'rare' },
          water:   { id: 'water', name: 'Oceanic', fill: '#29B6F6', stroke: '#0277BD', side: '#01579B', bg: 'bg-blue-50', text: 'text-blue-900', rarity: 'rare' },
          rose:    { id: 'rose', name: 'Rose Gold', fill: '#F48FB1', stroke: '#C2185B', side: '#880E4F', bg: 'bg-pink-50', text: 'text-pink-900', rarity: 'rare' },
          ice:     { id: 'ice', name: 'Frozen', fill: 'url(#icePattern)', stroke: '#0288D1', side: '#01579B', bg: 'bg-cyan-50', text: 'text-cyan-900', rarity: 'rare' },
          // NEW RARE
          denim:   { id: 'denim', name: 'Jean Jacket', fill: 'url(#denimPattern)', stroke: '#0D47A1', side: '#1565C0', bg: 'bg-blue-100', text: 'text-blue-900', rarity: 'rare' },
          bubblegum: { id: 'bubblegum', name: 'Pop Star', fill: 'url(#bubblePattern)', stroke: '#C2185B', side: '#EC407A', bg: 'bg-pink-100', text: 'text-pink-600', rarity: 'rare' },

          candy:   { id: 'candy', name: 'Peppermint', fill: 'url(#candyCanePattern)', stroke: '#D32F2F', side: '#B71C1C', bg: 'bg-red-50', text: 'text-red-900', rarity: 'epic' },
          cyber:   { id: 'cyber', name: 'Cyber Grid', fill: 'url(#cyberPattern)', stroke: '#00E676', side: '#00C853', bg: 'bg-black', text: 'text-green-400', rarity: 'epic', svgFilter: 'url(#neonGlow)' },
          zombie:  { id: 'zombie', name: 'Toxic Slime', fill: 'url(#zombiePattern)', stroke: '#33691E', side: '#1B5E20', bg: 'bg-lime-900', text: 'text-lime-400', rarity: 'epic', svgFilter: 'url(#neonGlow)' },
          camo:    { id: 'camo', name: 'Tactical', fill: 'url(#camoPattern)', stroke: '#1B5E20', side: '#33691E', bg: 'bg-stone-600', text: 'text-stone-100', rarity: 'epic' },
          nebula:  { id: 'nebula', name: 'Nebula', fill: 'url(#nebulaGradient)', stroke: '#4A148C', side: '#311B92', bg: 'bg-slate-950', text: 'text-pink-300', rarity: 'epic' },
          blueprint: { id: 'blueprint', name: 'Architect', fill: 'url(#blueprintPattern)', stroke: 'white', side: '#0D47A1', bg: 'bg-blue-900', text: 'text-blue-100', rarity: 'epic' },
          // NEW EPIC
          dragon:  { id: 'dragon', name: 'Dragon Scale', fill: 'url(#dragonPattern)', stroke: '#1B5E20', side: '#004D40', bg: 'bg-green-950', text: 'text-green-400', rarity: 'epic', svgFilter: 'url(#softShadow)' },
          circuit: { id: 'circuit', name: 'Motherboard', fill: 'url(#circuitPattern)', stroke: '#FFD700', side: '#004D40', bg: 'bg-teal-900', text: 'text-yellow-400', rarity: 'epic' },

          gold:    { id: 'gold', name: 'Solid Gold', fill: 'url(#goldGradient)', stroke: '#B8860B', side: '#D4AF37', bg: 'bg-yellow-50', text: 'text-yellow-800', rarity: 'legendary', svgFilter: 'url(#goldMetal)' },
          magma:   { id: 'magma', name: 'Volcanic', fill: 'url(#magmaPattern)', stroke: '#BF360C', side: '#D84315', bg: 'bg-orange-950', text: 'text-orange-200', rarity: 'legendary', svgFilter: 'url(#magmaGlow)' },
          glitch:  { id: 'glitch', name: 'ERR_0R', fill: 'url(#glitchPattern)', stroke: '#00FF00', side: '#333', bg: 'bg-gray-900', text: 'text-green-400', rarity: 'legendary', svgFilter: 'url(#glitchFilter)' },
          rainbow: { id: 'rainbow', name: 'Rainbow Dash', fill: 'url(#rainbowGradient)', stroke: '#C2185B', side: '#7B1FA2', bg: 'bg-white', text: 'text-purple-600', rarity: 'legendary' },
          matrix:  { id: 'matrix', name: 'The Source', fill: 'url(#matrixPattern)', stroke: '#00FF00', side: 'black', bg: 'bg-black', text: 'text-green-500', rarity: 'legendary' },
          // NEW LEGENDARY
          disco:   { id: 'disco', name: 'Mirrorball', fill: 'url(#discoPattern)', stroke: '#BDBDBD', side: '#9E9E9E', bg: 'bg-slate-200', text: 'text-slate-800', rarity: 'legendary', svgFilter: 'url(#discoGlow)' },
          portal:  { id: 'portal', name: 'Nether Vortex', fill: 'url(#portalPattern)', stroke: '#AA00FF', side: '#311B92', bg: 'bg-black', text: 'text-purple-300', rarity: 'legendary', svgFilter: 'url(#neonGlow)' },
          
          // --- MYTHIC TIER ---
          chrono:  { id: 'chrono', name: 'Timekeeper', fill: 'url(#chronoPattern)', stroke: '#FFD700', side: '#333', bg: 'bg-zinc-950', text: 'text-yellow-500', rarity: 'mythic' },
          hyper:   { id: 'hyper', name: 'Hyperdrive', fill: 'url(#hyperPattern)', stroke: 'white', side: 'black', bg: 'bg-black', text: 'text-cyan-400', rarity: 'mythic' },
          aurora:  { id: 'aurora', name: 'Northern Lights', fill: 'url(#auroraPattern)', stroke: '#00ff88', side: '#2E004F', bg: 'bg-slate-900', text: 'text-teal-300', rarity: 'mythic' },
          plasma:  { id: 'plasma', name: 'Plasma Arc', fill: 'url(#plasmaPattern)', stroke: '#00E5FF', side: '#01579B', bg: 'bg-blue-950', text: 'text-blue-400', rarity: 'mythic' },
          void:    { id: 'void', name: 'Singularity', fill: 'url(#voidPattern)', stroke: '#6200EA', side: 'black', bg: 'bg-black', text: 'text-purple-500', rarity: 'mythic' },
          bio:     { id: 'bio', name: 'Biohazard', fill: 'url(#bioPattern)', stroke: '#76FF03', side: '#1B5E20', bg: 'bg-green-950', text: 'text-lime-400', rarity: 'mythic' },
          prism:   { id: 'prism', name: 'Crystal Prism', fill: 'url(#prismPattern)', stroke: 'cyan', side: '#ECEFF1', bg: 'bg-slate-100', text: 'text-cyan-600', rarity: 'mythic' },
          rune:    { id: 'rune', name: 'Ancient Runes', fill: 'url(#runePattern)', stroke: '#00E5FF', side: '#263238', bg: 'bg-slate-800', text: 'text-cyan-200', rarity: 'mythic' },
          sonar:   { id: 'sonar', name: 'Deep Sonar', fill: 'url(#sonarPattern)', stroke: '#00FF00', side: '#002b11', bg: 'bg-green-950', text: 'text-green-500', rarity: 'mythic' },
          spirit:  { id: 'spirit', name: 'Lost Soul', fill: 'url(#spiritPattern)', stroke: '#CFD8DC', side: '#455A64', bg: 'bg-slate-700', text: 'text-slate-300', rarity: 'mythic' }
        };
        
        const STICKERS = [
          // Power Ups
          { id: 'fire', Icon: Flame, name: 'Heating Up', desc: 'Reach a Streak of 5', condition: (s) => s.streak >= 5, effect: 'animate-pulse', funDesc: "Heartbeat: The bakery comes alive!", hint: "Get 5 correct in a row." },
          // Changed effect from 'animate-bounce' to 'animate-bounce-gentle'
          { id: 'zap', Icon: Zap, name: 'Speed Demon', desc: 'Reach a Streak of 10', condition: (s) => s.streak >= 10, effect: 'animate-bounce-gentle', funDesc: "Bouncy Castle: A gentle hop!", hint: "Get 10 correct in a row." },
          { id: 'trophy', Icon: Trophy, name: 'Champion', desc: 'Earn 500 Coins', condition: (s) => s.totalCoins >= 500, effect: 'ring-4 ring-yellow-400', funDesc: "Gold Frame: Show off your bling!", hint: "Accumulate 500 total coins." },
          { id: 'ghost', Icon: Ghost, name: 'Spooky Mode', desc: 'Level 3 Unlock', condition: (s) => s.level >= 3, effect: 'grayscale invert', funDesc: "Night Vision: Inverts all colors!", hint: "Reach Level 3 (Line Cook)." },
          { id: 'skull', Icon: Skull, name: 'Earthquake', desc: 'Solve 20 Problems', condition: (s) => s.solved >= 20, effect: 'animate-shake', funDesc: "Rumble: Hold onto your chef hat!", hint: "Solve 20 problems total." },
          { id: 'eye', Icon: Eye, name: 'Wobbly World', desc: 'Unlock at Level 5', condition: (s) => s.level >= 5, effect: 'animate-spin-slow', funDesc: "Spin Cycle: Try not to get dizzy...", hint: "Reach Level 5 (Head Chef)." },
          { id: 'monitor', Icon: Monitor, name: 'Matrix', desc: 'Equip Cyber Skin', condition: (s, t) => t === 'cyber', effect: 'font-mono', funDesc: "Hacker Mode: Initiating sequence...", hint: "Requires 'Cyber Grid' theme equipped." },
          { id: 'gem', Icon: Gem, name: 'Bling Bling', desc: 'Earn 1000 Coins', condition: (s) => s.totalCoins >= 1000, effect: 'brightness-125 saturate-150', funDesc: "Deep Fried: Maximum brightness!", hint: "Accumulate 1000 total coins." },
          { id: 'rocket', Icon: Rocket, name: 'Blast Off', desc: 'Streak of 30', condition: (s) => s.streak >= 30, effect: 'animate-bounce duration-75', funDesc: "Hyper Speed: To the moon!", hint: "Get 30 correct in a row." },
          { id: 'shield', Icon: Shield, name: 'Guardian', desc: 'Reach Level 6', condition: (s) => s.level >= 6, effect: 'ring-4 ring-blue-500 ring-opacity-50', funDesc: "Forcefield: Protected!", hint: "Reach Level 6 (Bakery Owner)." },
          { id: 'magnet', Icon: Magnet, name: 'Coin Magnet', desc: 'Earn 2500 Coins', condition: (s) => s.totalCoins >= 2500, effect: 'shadow-xl shadow-yellow-400/50', funDesc: "Attraction: Money sticks to you!", hint: "Accumulate 2500 total coins." },
          
          // Achievements / Badges
          { id: 'smile', Icon: Smile, name: 'Happy Customer', desc: 'Welcome to the Bakery!', condition: () => true, rarity: 'common', hint: "Start the game." },
          { id: 'star', Icon: Star, name: 'Rising Star', desc: 'Reach Level 2', condition: (s) => s.level >= 2, rarity: 'common', hint: "Reach Level 2 (Prep Cook)." },
          { id: 'chef_hat', Icon: ChefHat, name: 'Top Chef', desc: 'Reach Level 4', condition: (s) => s.level >= 4, rarity: 'rare', hint: "Reach Level 4 (Sous Chef)." },
          { id: 'utensils', Icon: Utensils, name: 'Busy Kitchen', desc: 'Solved 50 Problems', condition: (s) => s.solved >= 50, color: 'text-blue-500', rarity: 'uncommon', hint: "Solve 50 total problems." },
          { id: 'coffee', Icon: Coffee, name: 'Early Riser', desc: 'Played before 9 AM', condition: () => new Date().getHours() < 9 && new Date().getHours() >= 4, color: 'text-amber-700', rarity: 'rare', hint: "Play the game between 4 AM and 9 AM." },
          { id: 'moon', Icon: Moon, name: 'Night Owl', desc: 'Played after 8 PM', condition: () => new Date().getHours() >= 20 || new Date().getHours() < 4, color: 'text-indigo-400', rarity: 'rare', hint: "Play the game after 8 PM." },
          { id: 'scale', Icon: Scale, name: 'On a Roll', desc: 'Streak of 20', condition: (s) => s.streak >= 20, color: 'text-cyan-600', rarity: 'epic', hint: "Get 20 correct answers in a row." },
          { id: 'medal', Icon: Award, name: 'Big Spender', desc: 'Earned 2000 Coins', condition: (s) => s.totalCoins >= 2000, color: 'text-yellow-500', rarity: 'rare', hint: "Accumulate 2000 total coins." },
          { id: 'crown', Icon: Crown, name: 'Bakery Tycoon', desc: 'Reach Level 6', condition: (s) => s.level >= 6, color: 'text-purple-600', rarity: 'legendary', hint: "Reach Level 6 (Bakery Owner)." },
          { id: 'heart', Icon: Heart, name: 'Dedicated', desc: 'Solved 100 Problems', condition: (s) => s.solved >= 100, color: 'text-pink-500', rarity: 'epic', hint: "Solve 100 total problems." },
          { id: 'key', Icon: Key, name: 'Collector', desc: 'Own 3 Themes', condition: (s) => s.inventoryCount >= 3, color: 'text-amber-500', rarity: 'uncommon', hint: "Unlock 3 different cake themes." },
          { id: 'gift', Icon: Gift, name: 'Hoarder', desc: 'Own 10 Stickers', condition: (s) => s.stickerCount >= 10, color: 'text-red-400', rarity: 'rare', hint: "Unlock 10 different stickers." },
          { id: 'bulb', Icon: Lightbulb, name: 'Bright Idea', desc: 'Streak of 50', condition: (s) => s.streak >= 50, color: 'text-yellow-500', rarity: 'legendary', hint: "Get 50 correct answers in a row!" },
          { id: 'flag', Icon: Flag, name: 'Franchise Owner', desc: 'Reach Level 7', condition: (s) => s.level >= 7, color: 'text-red-600', rarity: 'legendary', hint: "Reach Level 7 (Cake Boss)." },
          { id: 'glasses', Icon: Glasses, name: 'Nerd Alert', desc: 'Solve 200 Problems', condition: (s) => s.solved >= 200, color: 'text-slate-800', rarity: 'epic', hint: "Solve 200 total problems." },
          { id: 'briefcase', Icon: Briefcase, name: 'Business', desc: 'Own 10 Items', condition: (s) => s.inventoryCount + s.stickerCount >= 10, color: 'text-amber-800', rarity: 'uncommon', hint: "Own at least 10 items total." },
          { id: 'calculator', Icon: Calculator, name: 'Math Whiz', desc: 'Solve 300 Problems', condition: (s) => s.solved >= 300, color: 'text-green-600', rarity: 'legendary', hint: "Solve 300 total problems." },
          { id: 'palette', Icon: Palette, name: 'Art Collector', desc: 'Own 5 Themes', condition: (s) => s.inventoryCount >= 5, color: 'text-purple-500', rarity: 'rare', hint: "Unlock 5 different cake themes." },
          { id: 'clock', Icon: Watch, name: 'Lunch Break', desc: 'Play 11am-1pm', condition: () => new Date().getHours() >= 11 && new Date().getHours() <= 13, color: 'text-orange-500', rarity: 'common', hint: "Play between 11 AM and 1 PM." },
          { id: 'cloud', Icon: Cloud, name: 'Dreamer', desc: 'Play 12am-4am', condition: () => new Date().getHours() >= 0 && new Date().getHours() < 4, color: 'text-sky-300', rarity: 'epic', hint: "Play between Midnight and 4 AM." }
        ];

        // --- CUSTOMIZATION ITEMS ---
        const BACKGROUNDS = {
            'default': { id: 'default', name: 'Night Shift', class: 'bg-slate-900', cost: 0 },
            'parisian': { id: 'parisian', name: 'Parisian Café', class: 'bg-[#2c2436]', cost: 800 },
            'space': { id: 'space', name: 'Space Station', class: 'bg-black', cost: 1200 },
            'underwater': { id: 'underwater', name: 'Deep Sea', class: 'bg-cyan-950', cost: 1000 },
            'haunted': { id: 'haunted', name: 'Spooky Manor', class: 'bg-purple-950', cost: 1500 }
        };

        const COUNTERTOPS = {
            'default': { id: 'default', name: 'Standard Steel', class: 'bg-slate-800', cost: 0 },
            'marble': { id: 'marble', name: 'Black Marble', class: 'bg-neutral-800', cost: 500 },
            'wood': { id: 'wood', name: 'Oak Wood', class: 'bg-amber-900/40', cost: 600 },
            'neon': { id: 'neon', name: 'Neon Grid', class: 'bg-indigo-950 border-2 border-cyan-500', cost: 1000 },
            'lava': { id: 'lava', name: 'Obsidian', class: 'bg-stone-900', cost: 1200 }
        };

        const DECORATIONS = {
            'whisk': { id: 'whisk', name: 'Golden Whisk', icon: React.createElement(Utensils, { className: "text-yellow-400" }), cost: 400 },
            'cat': { id: 'cat', name: 'Lucky Cat', icon: React.createElement(Heart, { className: "text-pink-400" }), cost: 500 },
            'diploma': { id: 'diploma', name: 'Diploma', icon: React.createElement(FileText, { className: "text-slate-200" }), cost: 300 },
            'plant': { id: 'plant', name: 'Succulent', icon: React.createElement(Trophy, { className: "text-green-400" }), cost: 200 }, // Trophy icon reused as plant-like
            'globe': { id: 'globe', name: 'Snow Globe', icon: React.createElement(Cloud, { className: "text-blue-300" }), cost: 600 }
        };

        const RECIPES = {
            'grilled_cheese': {
                id: 'grilled_cheese',
                name: 'Perfect Grilled Cheese',
                desc: 'Golden, crispy, and cheesy!',
                icon: React.createElement(Disc, { className: "text-yellow-500" }),
                ingredients: ['2 slices bread', '2 slices cheddar/American cheese', '1 tbsp butter (room temp)'],
                steps: [
                    '1. Get a frying pan. Don\'t turn the heat on yet.',
                    '2. Butter one side of each bread slice.',
                    '3. Place one slice in pan, butter-side down.',
                    '4. Add cheese slices. Top with second bread slice (butter-side up).',
                    '5. Turn heat to Medium-Low. Cook 3-4 mins until golden.',
                    '6. Flip carefully. Cook other side 2-3 mins.',
                    '7. Turn off stove. Cut diagonally and eat!'
                ]
            },
            'mac_cheese': {
                id: 'mac_cheese',
                name: 'Stovetop Mac & Cheese',
                desc: 'Better than the box!',
                icon: React.createElement(Box, { className: "text-orange-400" }),
                ingredients: ['2 cups macaroni', '2 tbsp butter', '2 tbsp flour', '1.5 cups milk', '2 cups cheddar cheese', 'Seasoning: salt, pepper, garlic powder'],
                steps: [
                    '1. Boil pasta for 8-10 mins. Drain.',
                    '2. In empty pot on Medium heat, melt butter.',
                    '3. Whisk in flour for 1 min (making a "Roux").',
                    '4. Slowly pour in milk while whisking. Add seasonings.',
                    '5. Stir 3-4 mins until thick like cream.',
                    '6. Turn heat Low. Stir in cheese until melted.',
                    '7. Add pasta back in. Stir to coat.'
                ]
            },
            'spaghetti': {
                id: 'spaghetti',
                name: 'Spaghetti Meat Sauce',
                desc: 'A classic Italian dinner.',
                icon: React.createElement(UtensilsCrossed, { className: "text-red-600" }),
                ingredients: ['1/2 box spaghetti', '1 jar marinara (24oz)', '1 lb ground beef/turkey', 'Seasoning: onion powder, oregano, salt'],
                steps: [
                    '1. Pan on Medium-High. Brown the meat (7-8 mins).',
                    '2. Ask an adult to help drain the grease.',
                    '3. Add seasonings and jar of sauce. Simmer on Low.',
                    '4. Boil a pot of water. Cook pasta 10 mins.',
                    '5. Drain water. Serve noodles with sauce on top.'
                ]
            },
            'scrambled_eggs': {
                id: 'scrambled_eggs',
                name: 'Fluffy Scrambled Eggs',
                desc: 'Breakfast of champions.',
                icon: React.createElement(Wheat, { className: "text-yellow-300" }), // Using Wheat as placeholder for farm/eggs
                ingredients: ['2 large eggs', '1 tbsp milk', '1 tsp butter', 'Salt and pepper'],
                steps: [
                    '1. Crack eggs into a bowl. Pick out any shells!',
                    '2. Add milk, salt, pepper. Whisk until bubbly.',
                    '3. Pan on Medium heat. Melt butter.',
                    '4. Pour eggs in. Wait 10 seconds.',
                    '5. Gently push eggs with spatula for 2 mins until soft clouds form.',
                    '6. Turn off stove immediately.'
                ]
            },
            'quesadilla': {
                id: 'quesadilla',
                name: 'Chicken Quesadilla',
                desc: 'Cheesy, crispy triangles.',
                icon: React.createElement(Disc, { className: "text-orange-200" }),
                ingredients: ['2 flour tortillas', '1 cup Mexican blend cheese', '1/2 cup cooked chicken', 'Pinch of cumin (optional)'],
                steps: [
                    '1. Pan on Medium heat. Place one tortilla in.',
                    '2. Sprinkle cheese all over. Add chicken to ONE half.',
                    '3. Wait 1 min for cheese to melt.',
                    '4. Fold the cheese-only side over the chicken side (like a book).',
                    '5. Cook 1 min per side until crispy. Cut into wedges.'
                ]
            },
            'tacos': {
                id: 'tacos',
                name: 'Taco Night',
                desc: 'Crunchy or Soft Shell?',
                icon: React.createElement(Compass, { className: "text-yellow-600" }),
                ingredients: ['1 lb ground beef', 'Taco Seasoning packet', '1/2 cup water', 'Taco shells', 'Toppings: lettuce, cheese, tomato'],
                steps: [
                    '1. Brown beef in pan on Medium-High. Drain grease.',
                    '2. Add water and seasoning packet. Stir.',
                    '3. Simmer on Low for 5 mins until thick.',
                    '4. While cooking, wash and chop lettuce/tomatoes.',
                    '5. Spoon meat into shells and add toppings.'
                ]
            },
            'french_toast': {
                id: 'french_toast',
                name: 'Cinnamon French Toast',
                desc: 'Sweet and custardy.',
                icon: React.createElement(Cookie, { className: "text-amber-800" }),
                ingredients: ['4 slices thick bread', '2 eggs', '1/2 cup milk', '1 tsp vanilla', 'Cinnamon', 'Butter'],
                steps: [
                    '1. Whisk eggs, milk, vanilla, and cinnamon in a shallow bowl.',
                    '2. Pan on Medium heat. Melt a little butter.',
                    '3. Dip bread in egg mix. Flip immediately (don\'t soak!).',
                    '4. Cook 2-3 mins per side until brown.',
                    '5. Serve with syrup!'
                ]
            },
            'mashed_potatoes': {
                id: 'mashed_potatoes',
                name: 'Mashed Potatoes',
                desc: 'Smooth and fluffy.',
                icon: React.createElement(Cloud, { className: "text-stone-300" }),
                ingredients: ['4 medium Gold potatoes', '2 tbsp butter', '1/4 cup milk', 'Salt and garlic powder'],
                steps: [
                    '1. Peel and wash potatoes. Cut into cubes.',
                    '2. Boil in pot of water on High for 15 mins until soft.',
                    '3. Drain water in sink using a strainer.',
                    '4. Put potatoes back in pot.',
                    '5. Add butter, milk, seasonings.',
                    '6. Mash with potato masher until smooth.'
                ]
            },
            'burgers': {
                id: 'burgers',
                name: 'Pan-Fried Burgers',
                desc: 'Juicy stovetop burgers.',
                icon: React.createElement(Disc, { className: "text-amber-900" }),
                ingredients: ['1 lb ground beef', 'Buns', 'Salt, pepper, garlic powder', 'Toppings: ketchup, mustard, pickles'],
                steps: [
                    '1. Mix beef and seasonings gently with CLEAN hands.',
                    '2. Form into 4 flat patties. Wash hands!',
                    '3. Heat pan on Medium-High.',
                    '4. Cook patties 4 mins. Flip.',
                    '5. Cook 3-4 mins more.',
                    '6. Turn off heat. Put on buns with toppings.'
                ]
            },
            'pizza': {
                id: 'pizza',
                name: 'Homemade Pizza',
                desc: 'Better than delivery.',
                icon: React.createElement(PieChart, { className: "text-red-500" }),
                ingredients: ['Pizza dough (store bought)', '1/2 cup pizza sauce', '1.5 cups mozzarella', 'Pepperoni', 'Oregano'],
                steps: [
                    '1. Preheat oven to 400°F. Spray baking sheet with oil.',
                    '2. Stretch dough flat onto the pan.',
                    '3. Spread sauce (leave edges plain for crust!).',
                    '4. Sprinkle cheese, pepperoni, and oregano.',
                    '5. Bake 12-15 mins until cheese bubbles.',
                    '6. Cool for 5 mins before cutting.'
                ]
            }
        };

        // --- CHEF GEAR ---
        const HATS = {
            'default': { id: 'default', name: 'Chef Hat', Icon: ChefHat, cost: 0 },
            'crown': { id: 'crown', name: 'Royal Crown', Icon: Crown, cost: 500, color: 'text-yellow-400' },
            'party': { id: 'party', name: 'Party Hat', Icon: Sparkles, cost: 300, color: 'text-pink-400' },
            'wizard': { id: 'wizard', name: 'Wizard Hat', Icon: Wand2, cost: 800, color: 'text-purple-400' },
            'viking': { id: 'viking', name: 'Viking Helmet', Icon: Sword, cost: 600, color: 'text-slate-300' }
        };

        // Tools modify the cursor using SVG data URIs
        const TOOLS = {
            'default': { id: 'default', name: 'Pointer', icon: 'default', cost: 0 },
            'spatula': { id: 'spatula', name: 'Spatula', icon: `url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="black" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-utensils-crossed"><path d="M14.5 4h-5L7 7H4a2 2 0 0 0-2 2v1a6 6 0 0 0 6 6h1l3 3"/><path d="m3 21 6-6"/></svg>') 16 16, auto`, cost: 300 },
            'whisk': { id: 'whisk', name: 'Whisk', icon: `url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="black" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M17.5 19c0-1.7-1.3-3-3-3s-3 1.3-3 3 1.3 3 3 3 3-1.3 3-3Z"/><path d="M14.5 19v-2"/><path d="M11.5 19v-5"/><path d="M8.5 19v-2"/><path d="M5.5 19c0-1.7 1.3-3 3-3s3 1.3 3 3-1.3 3-3 3-3-1.3-3-3Z"/><line x1="2" x2="22" y1="2" y2="22"/></svg>') 16 16, auto`, cost: 300 },
            'wand': { id: 'wand', name: 'Magic Wand', icon: `url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="purple" stroke="gold" stroke-width="2"><path d="m21.64 3.64-1.28-1.28a1.21 1.21 0 0 0-1.72 0L2.36 18.64a1.21 1.21 0 0 0 0 1.72l1.28 1.28a1.2 1.2 0 0 0 1.72 0L21.64 5.36a1.2 1.2 0 0 0 0-1.72Z"/><path d="m14 7 3 3"/><path d="M5 6v4"/><path d="M19 14v4"/><path d="M10 2v2"/><path d="M7 8H3"/><path d="M21 16h-4"/></svg>') 0 24, auto`, cost: 800 },
            'saber': { id: 'saber', name: 'Laser Sword', icon: `url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="red" stroke="red" stroke-width="2"><path d="M14.5 17.5 3 6V3h3l11.5 11.5"/><path d="m13 19 6-6"/><path d="M16 16 20 20"/><path d="M19 21 21 19"/></svg>') 0 24, auto`, cost: 1000 }
        };

        const APRONS = {
            'default': { id: 'default', name: 'White Apron', color: 'bg-slate-200 text-slate-800', cost: 0 },
            'blue': { id: 'blue', name: 'Blue Apron', color: 'bg-blue-500 text-white', cost: 200 },
            'green': { id: 'green', name: 'Green Apron', color: 'bg-green-500 text-white', cost: 200 },
            'camo': { id: 'camo', name: 'Camo Apron', color: 'bg-stone-600 text-stone-300', cost: 500 },
            'gold': { id: 'gold', name: 'Golden Apron', color: 'bg-yellow-400 text-yellow-900', cost: 2000 }
        };

        // --- PET CUSTOMIZATION ---
        const PET_SKINS = {
            'default': { id: 'default', name: 'Sourdough', color: '#F5E6CA', cost: 0 },
            'wheat': { id: 'wheat', name: 'Whole Wheat', color: '#A1887F', cost: 200 },
            'matcha': { id: 'matcha', name: 'Matcha', color: '#C5E1A5', cost: 300 },
            'berry': { id: 'berry', name: 'Strawberry', color: '#F48FB1', cost: 400 },
            'ghost': { id: 'ghost', name: 'Ghost Dough', color: '#E0F7FA', cost: 600 },
            // ANIMATED SKINS
            'galaxy': { id: 'galaxy', name: 'Cosmic Dough', color: 'url(#galaxyPattern)', cost: 1000 },
            'magma': { id: 'magma', name: 'Lava Blob', color: 'url(#magmaPattern)', cost: 1200 },
            'glitch': { id: 'glitch', name: 'Glitch Pet', color: 'url(#glitchPattern)', cost: 1500 },
            'disco': { id: 'disco', name: 'Boogie Dough', color: 'url(#discoPattern)', cost: 1800 },
            'chrono': { id: 'chrono', name: 'Time Pet', color: 'url(#chronoPattern)', cost: 2500 },
            'portal': { id: 'portal', name: 'Void Pet', color: 'url(#portalPattern)', cost: 3000 }
        };

        const PET_HATS = {
            'none': { id: 'none', name: 'No Hat', icon: null, cost: 0 },
            'chef': { id: 'chef', name: 'Tiny Toque', icon: React.createElement(ChefHat, { size: 32, className: "text-white drop-shadow-md", strokeWidth: 2 }), cost: 150 },
            'party': { id: 'party', name: 'Party Hat', icon: React.createElement(Sparkles, { size: 32, className: "text-pink-500 drop-shadow-md", strokeWidth: 2 }), cost: 200 },
            'crown': { id: 'crown', name: 'Mini Crown', icon: React.createElement(Crown, { size: 32, className: "text-yellow-400 drop-shadow-md", strokeWidth: 2 }), cost: 500 },
            'viking': { id: 'viking', name: 'Tiny Helmet', icon: React.createElement(Sword, { size: 32, className: "text-slate-300 drop-shadow-md", strokeWidth: 2 }), cost: 400 }
        };

        const RANKS = [
          { level: 1, title: "Dishwasher", xp: 0 },
          { level: 2, title: "Prep Cook", xp: 12000 },      
          { level: 3, title: "Line Cook", xp: 36000 },     
          { level: 4, title: "Sous Chef", xp: 72000 },    
          { level: 5, title: "Head Chef", xp: 144000 },    
          { level: 6, title: "Bakery Owner", xp: 300000 },
          { level: 7, title: "Cake Boss", xp: 600000 },   
        ];

        // Stations Costs for Economy-based Progression
        const STATION_COSTS = {
            'frac-mult-frac': 0, // Prep Station (Free)
            'snack-sharing': 50, // Catering
            'cake-decorator': 150, // Design Station
            'whole-div-unit': 300, // The Ovens
            'word-match': 600, // Order Counter
            'comparison': 1000 // Quality Control
        };

        const PROBLEM_TEMPLATES = [
          { type: 'mult', templates: ["A recipe calls for {A} cups of flour. You only want to make {F} of the recipe. How much flour do you need?", "You have {A} trays of brownies. You give away {F} of each tray to the neighbors. How many total trays worth did you give away?", "A garden plot is {A} yards long. You plant flowers in {F} of the length. How many yards of flowers are there?"] },
          { type: 'whole-first', templates: ["We have {A} kg of dough. Each loaf of bread needs {F} kg. How many loaves can we make?", "You have {A} liters of lemonade. A serving size is {F} liter. How many servings can you pour?", "A hiking trail is {A} miles long. There is a marker every {F} mile. How many markers are there?"] },
          { type: 'frac-first', templates: ["We have {F} of a wedding cake left. We share it equally among {A} staff members. How much does each person get?", "You have {F} gallon of paint. You use it to paint {A} identical walls. How much paint does each wall get?", "A relay race is {F} mile long. It is split equally among {A} runners. How far does each runner run?"] }
        ];

        // --- COMPONENTS ---
        
        // Pet Companion Component
        const PetCompanion = ({ level, skinId, hatId, onFeed, canAffordFeed, coins, isHappy, isEating, className }) => {
            const skin = PET_SKINS[skinId] || PET_SKINS.default;
            const hat = PET_HATS[hatId] || PET_HATS.none;

            const getHat = () => {
                if (hat.id !== 'none') {
                    return React.createElement("div", { key: "hat", className: "absolute -top-6 left-1/2 -translate-x-1/2 z-20 transform -rotate-12" },
                        hat.icon
                    );
                }
                return null;
            };

            const getFace = () => {
                const face = [];
                if (level >= 3) { // Eyes
                    face.push(
                        React.createElement("div", { key: "eyes", className: "absolute top-1/3 w-full flex justify-center gap-4" },
                            React.createElement("div", { className: "w-2 h-2 bg-black rounded-full" }),
                            React.createElement("div", { className: "w-2 h-2 bg-black rounded-full" })
                        )
                    );
                }
                if (level >= 4) { // Smile
                     face.push(
                        React.createElement("div", { key: "mouth", className: "absolute top-1/2 left-1/2 -translate-x-1/2 w-4 h-2 border-b-2 border-black rounded-full" })
                     );
                }
                if (level >= 5) { // Mustache
                     face.push(
                        React.createElement("div", { key: "stache", className: "absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1 text-black" }, "〰️")
                     );
                }
                if (level >= 6) { // Glasses
                     face.push(
                        React.createElement("div", { key: "glasses", className: "absolute top-1/3 left-1/2 -translate-x-1/2 w-12 flex justify-center" }, 
                           React.createElement(Glasses, { size: 24, className: "text-black fill-black/50" })
                        )
                     );
                }
                return face;
            };

            return React.createElement("div", { className: className || "fixed bottom-4 left-4 z-40 flex flex-col items-center group" },
                // Feed Button (visible on hover or always if Menu)
                React.createElement("button", { 
                    onClick: onFeed,
                    disabled: !canAffordFeed,
                    className: `mb-2 px-3 py-1 bg-yellow-100 text-yellow-800 rounded-full text-xs font-bold shadow-md transform transition-all scale-0 group-hover:scale-100 flex items-center gap-1 ${canAffordFeed ? 'hover:bg-yellow-200' : 'opacity-50 cursor-not-allowed'}` 
                }, 
                    React.createElement(Wheat, { size: 12 }), "Feed (50G)"
                ),
                
                // The Pet Animation Wrapper
                React.createElement("div", { 
                    className: `relative w-20 h-20 transition-all duration-300 ${isHappy ? 'animate-bounce-happy' : 'animate-wobble'} ${isEating ? 'animate-eat' : ''}` 
                },
                    // 1. Hat sits OUTSIDE the overflow-hidden body so it pops out
                    getHat(),

                    // 2. The Body Container (Clipped to blob shape)
                    React.createElement("div", { 
                        className: "w-full h-full shadow-xl transition-all duration-500 overflow-hidden relative",
                        style: {
                            borderRadius: "40% 60% 70% 30% / 40% 50% 60% 50%", 
                        }
                    },
                       // A. Background SVG (Handles Patterns & Colors)
                       React.createElement("svg", { width: "100%", height: "100%", className: "absolute inset-0" },
                           React.createElement("rect", { width: "100%", height: "100%", fill: skin.color })
                       ),
                       
                       // B. Inner Shadow Overlay (for depth)
                       React.createElement("div", { className: "absolute inset-0 pointer-events-none", style: { boxShadow: "inset -4px -4px 10px rgba(0,0,0,0.2)" } }),
                       
                       // C. Face Features
                       getFace()
                    )
                ),
                // Level Tag
                React.createElement("div", { className: "mt-1 bg-slate-800 text-white text-[10px] px-2 py-0.5 rounded-full border border-slate-600" }, 
                    `Lvl ${level}`
                )
            );
        };

        const Render3DCake = ({ type, pieces, highlight, themeId, onClick, interactive = false }) => {
          const t = THEMES[themeId] || THEMES.classic;
          const [cutPieces, setCutPieces] = useState(0);
          
          useEffect(() => {
             if (interactive && type === 'round') {
                 setCutPieces(0); // Reset when props change
             }
          }, [pieces, interactive, type]);

          const handleClick = () => {
             if (interactive && onClick) {
                 onClick();
             }
          };

          if (type === 'round') {
            return React.createElement("div", { onClick: handleClick, className: `relative w-32 h-32 transform transition-all duration-500 hover:scale-105 group ${interactive ? 'cursor-pointer' : ''}` },
               React.createElement("svg", { viewBox: "0 0 100 100", className: "w-full h-full drop-shadow-2xl overflow-visible" },
                 React.createElement("ellipse", { cx: "50", cy: "85", rx: "40", ry: "10", fill: "black", opacity: "0.2", filter: "url(#softShadow)" }),
                 React.createElement("path", { d: "M 10 50 L 10 75 Q 50 95 90 75 L 90 50 Q 50 70 10 50", fill: t.side }),
                 React.createElement("ellipse", { cx: "50", cy: "50", rx: "40", ry: "20", fill: t.fill, stroke: t.stroke, strokeWidth: "2", filter: t.svgFilter }),
                 pieces > 1 && Array.from({ length: pieces }).map((_, i) => {
                     const angle = (i * 360) / pieces;
                     const rad = (angle * Math.PI) / 180;
                     const x = 50 + 40 * Math.cos(rad);
                     const y = 50 + 20 * Math.sin(rad);
                     return React.createElement("line", { key: i, x1: "50", y1: "50", x2: x, y2: y, stroke: t.stroke, strokeWidth: "1", opacity: "0.8" });
                 }),
                 React.createElement("ellipse", { cx: "50", cy: "50", rx: "38", ry: "18", fill: "url(#lightingOverlay)", pointerEvents: "none" })
               )
            );
          } 
          // Rectangular (used for unit fractions)
          return React.createElement("div", { onClick: handleClick, className: `relative w-48 h-32 transform transition-all duration-500 hover:scale-105 ${interactive ? 'cursor-pointer' : ''}` },
               React.createElement("div", { className: "absolute top-2 left-2 w-full h-full bg-slate-800 rounded-lg opacity-20 filter blur-sm" }),
               React.createElement("div", { className: "absolute bottom-0 w-full h-4 bg-slate-600 rounded-b-lg border-2 border-slate-700" }),
               React.createElement("div", { className: "absolute top-0 w-full h-[90%] bg-slate-100 rounded-lg border-4 border-slate-700 overflow-hidden flex flex-col" },
                  React.createElement("div", { className: "flex-grow w-full relative p-1" },
                     React.createElement("svg", { width: "100%", height: "100%" },
                       React.createElement("rect", { x: "2%", y: "2%", width: "96%", height: "96%", fill: t.fill, filter: t.svgFilter, rx: "4" }),
                       pieces > 1 && Array.from({length: pieces}).map((_, i) => (
                          React.createElement("line", { key: `v-${i}`, x1: `${(i/pieces)*100}%`, y1: "2%", x2: `${(i/pieces)*100}%`, y2: "98%", stroke: t.stroke, strokeWidth: "2", strokeDasharray: "4 4" })
                       ))
                     )
                  )
               )
          );
        };

        const StationCard = ({ title, desc, icon, onClick, color, locked, cost, canAfford, onUnlock }) => (
          React.createElement("button", { 
            onClick: locked ? (canAfford ? onUnlock : null) : onClick, 
            className: `relative p-1 rounded-3xl transform transition text-left h-48 group ${
                locked 
                ? (canAfford ? 'bg-slate-700 border-2 border-green-500 cursor-pointer hover:scale-105' : 'bg-slate-800 grayscale cursor-not-allowed opacity-80 border-2 border-slate-600') 
                : `bg-gradient-to-br ${color} hover:scale-105 active:scale-95 shadow-lg`
            }` 
          },
            React.createElement("div", { className: "bg-slate-900/40 h-full w-full rounded-[20px] p-6 flex flex-col justify-between backdrop-blur-sm group-hover:bg-transparent transition-colors" },
               React.createElement("div", { className: "flex justify-between items-start" },
                   React.createElement("div", { className: "bg-white/20 w-12 h-12 rounded-xl flex items-center justify-center text-white shadow-inner" }, 
                      locked ? React.createElement(Lock, { size: 24 }) : icon
                   ),
                   locked && React.createElement("div", { className: `px-3 py-1 rounded-full text-sm font-bold flex items-center gap-1 ${canAfford ? 'bg-green-500 text-white' : 'bg-slate-700 text-slate-400'}` },
                       cost, " G"
                   )
               ),
               React.createElement("div", null,
                 React.createElement("h3", { className: "text-2xl font-black text-white" }, title),
                 React.createElement("div", { className: "text-white/80 font-medium text-sm" }, 
                    locked 
                        ? (canAfford ? "TAP TO UNLOCK" : "LOCKED") 
                        : desc
                 )
               )
            )
          )
        );

        const FeedbackDisplay = ({ feedback, onNext, onRetry }) => (
          React.createElement("div", { className: "flex flex-col items-center gap-4 w-full animate-in slide-in-from-bottom-4 duration-300 mt-6" },
            React.createElement("div", { className: `text-2xl font-black text-center ${feedback.type === 'success' ? 'text-green-500' : 'text-red-400'}` }, feedback.message),
            
            // New Explainer Section
            feedback.explanation && React.createElement("div", { className: "bg-slate-900/50 p-4 rounded-xl border border-slate-600 text-slate-300 text-sm md:text-base max-w-lg text-center leading-relaxed" },
               feedback.explanation
            ),

            feedback.type === 'success' ? 
                React.createElement("button", { onClick: onNext, className: "flex items-center gap-2 bg-slate-800 hover:bg-slate-900 text-white px-8 py-3 rounded-full font-bold shadow-lg transform hover:scale-105 transition-all" }, "Next Order ", React.createElement(ArrowRight, { size: 20 }))
            : 
                React.createElement("button", { onClick: onRetry, className: "flex items-center gap-2 text-slate-500 hover:text-slate-700 px-4 py-2 font-bold hover:bg-slate-100 rounded-full transition-colors" }, React.createElement(RefreshCw, { size: 16 }), " Try Again")
          )
        );

        // --- MAIN APP COMPONENT ---
        const FractionGame = () => {
          const [mode, setMode] = useState('menu'); 
          const [shopTab, setShopTab] = useState('bakery'); // 'bakery' or 'chef' or 'renovate' or 'cookbook' or 'pet'
          const [gameType, setGameType] = useState(null); 
          const [user, setUser] = useState(null);

          const [coins, setCoins] = useState(5); 
          const [totalCoins, setTotalCoins] = useState(5); 
          const [solvedCount, setSolvedCount] = useState(0);
          const [xp, setXp] = useState(0);
          const [inventory, setInventory] = useState(['classic', 'choco', 'berry']); 
          const [stickers, setStickers] = useState(['smile', 'star', 'chef_hat']); 
          const [unlockedStations, setUnlockedStations] = useState(['frac-mult-frac']);
          
          // Pet State
          const [petXp, setPetXp] = useState(0);
          const [petLevel, setPetLevel] = useState(1);
          const [isPetHappy, setIsPetHappy] = useState(false);
          const [isPetEating, setIsPetEating] = useState(false);
          
          // Pet Inventory
          const [petSkins, setPetSkins] = useState(['default']);
          const [petHats, setPetHats] = useState(['none']);
          const [equippedPetSkin, setEquippedPetSkin] = useState('default');
          const [equippedPetHat, setEquippedPetHat] = useState('none');
          
          // Pet Shop UI State
          const [previewPetSkin, setPreviewPetSkin] = useState(null);
          const [previewPetHat, setPreviewPetHat] = useState(null);
          const [selectedPetItem, setSelectedPetItem] = useState(null); // { type: 'skin'|'hat', id: string }

          // Chef Gear Inventory
          const [hats, setHats] = useState(['default']);
          const [tools, setTools] = useState(['default']);
          const [aprons, setAprons] = useState(['default']);
          const [equippedHat, setEquippedHat] = useState('default');
          const [equippedTool, setEquippedTool] = useState('default');
          const [equippedApron, setEquippedApron] = useState('default');

          // Renovation Inventory
          const [backgrounds, setBackgrounds] = useState(['default']);
          const [countertops, setCountertops] = useState(['default']);
          const [decorations, setDecorations] = useState([]);
          const [equippedBackground, setEquippedBackground] = useState('default');
          const [equippedCountertop, setEquippedCountertop] = useState('default');
          
          // Recipes
          const [unlockedRecipes, setUnlockedRecipes] = useState([]);
          const [selectedRecipe, setSelectedRecipe] = useState(null);

          const [equippedTheme, setEquippedTheme] = useState('classic');
          const [equippedSticker, setEquippedSticker] = useState(null); 
          
          const [streak, setStreak] = useState(0);
          const [missedStreak, setMissedStreak] = useState(0); // New state for demotion tracking
          const [feedback, setFeedback] = useState(null);
          const [currentProblem, setCurrentProblem] = useState(null);
          const [userVisualState, setUserVisualState] = useState(0);
          const [userAnswer, setUserAnswer] = useState('');
          const [decoratorGrid, setDecoratorGrid] = useState([]);
          const [ovenState, setOvenState] = useState([]); // Track cut cakes
          const [snackState, setSnackState] = useState({ plates: [], pool: 0 });
          const [animationStep, setAnimationStep] = useState(0);
          
          const [previewTheme, setPreviewTheme] = useState('classic');
          const [isOpeningCrate, setIsOpeningCrate] = useState(false);
          const [crateReward, setCrateReward] = useState(null);
          const [showConfetti, setShowConfetti] = useState(false);
          const [showSparkles, setShowSparkles] = useState(false);
          const [levelUp, setLevelUp] = useState(null);
          const [newUnlock, setNewUnlock] = useState(null); 
          const [showSettings, setShowSettings] = useState(false);
          
          // Daily Challenge State
          const [dailyChallenge, setDailyChallenge] = useState({ lastCompleted: null });

          const [musicEnabled, setMusicEnabled] = useState(false);
          const [trackIndex, setTrackIndex] = useState(0);
          const audioRef = useRef(null);
          const fileInputRef = useRef(null);

          // Derived
          const getCurrentRank = () => [...RANKS].reverse().find(r => xp >= r.xp) || RANKS[0];
          const getNextRank = () => RANKS.find(r => r.xp > xp) || { xp: xp, title: "Max Level" };
          const currentRank = getCurrentRank();
          const xpPercentage = Math.min(100, (xp / getNextRank().xp) * 100);
          const activeStickerData = STICKERS.find(s => s.id === equippedSticker);
          const activeEffectClass = activeStickerData ? activeStickerData.effect : '';
          const t = THEMES[equippedTheme] || THEMES.classic;
          
          const currentHat = HATS[equippedHat] || HATS.default;
          const currentApron = APRONS[equippedApron] || APRONS.default;
          const currentTool = TOOLS[equippedTool] || TOOLS.default;
          
          const currentBg = BACKGROUNDS[equippedBackground] || BACKGROUNDS.default;
          const currentCounter = COUNTERTOPS[equippedCountertop] || COUNTERTOPS.default;

          // Apply cursor effect
          useEffect(() => {
              if (currentTool.id !== 'default') {
                  document.body.style.cursor = currentTool.icon;
              } else {
                  document.body.style.cursor = 'auto';
              }
          }, [equippedTool]);

          // Auth
          useEffect(() => {
            const initAuth = async () => {
              if (!auth) return;
              try { await signInAnonymously(auth); } 
              catch (error) { console.warn("Auth failed"); }
            };
            initAuth();
            if (auth) {
                const unsubscribe = onAuthStateChanged(auth, setUser);
                return () => unsubscribe();
            }
          }, []);

          // Sync
          useEffect(() => {
            if (!user || !db) return;
            const userDocRef = doc(db, 'artifacts', appId, 'users', user.uid, 'data', 'gameProgress');
            const unsubscribe = onSnapshot(userDocRef, (docSnapshot) => {
              if (docSnapshot.exists()) {
                const data = docSnapshot.data();
                setCoins(data.coins ?? 5);
                setTotalCoins(data.totalCoins ?? 5);
                setXp(data.xp ?? 0);
                setStreak(data.streak ?? 0);
                setSolvedCount(data.solvedCount ?? 0);
                if(data.inventory) setInventory(data.inventory);
                if(data.stickers) setStickers(data.stickers);
                if(data.unlockedStations) setUnlockedStations(data.unlockedStations);
                if(data.equippedTheme) setEquippedTheme(data.equippedTheme);
                if(data.equippedSticker !== undefined) setEquippedSticker(data.equippedSticker);
                if(data.dailyChallenge) setDailyChallenge(data.dailyChallenge);
                
                // Load Chef Gear
                if(data.hats) setHats(data.hats);
                if(data.tools) setTools(data.tools);
                if(data.aprons) setAprons(data.aprons);
                if(data.equippedHat) setEquippedHat(data.equippedHat);
                if(data.equippedTool) setEquippedTool(data.equippedTool);
                if(data.equippedApron) setEquippedApron(data.equippedApron);

                // Load Renovations
                if(data.backgrounds) setBackgrounds(data.backgrounds);
                if(data.countertops) setCountertops(data.countertops);
                if(data.decorations) setDecorations(data.decorations);
                if(data.equippedBackground) setEquippedBackground(data.equippedBackground);
                if(data.equippedCountertop) setEquippedCountertop(data.equippedCountertop);
                
                // Load Pet & Recipes
                if(data.petXp !== undefined) setPetXp(data.petXp);
                if(data.petLevel !== undefined) setPetLevel(data.petLevel);
                if(data.unlockedRecipes) setUnlockedRecipes(data.unlockedRecipes);
                if(data.petSkins) setPetSkins(data.petSkins);
                if(data.petHats) setPetHats(data.petHats);
                if(data.equippedPetSkin) setEquippedPetSkin(data.equippedPetSkin);
                if(data.equippedPetHat) setEquippedPetHat(data.equippedPetHat);
              }
            });
            return () => unsubscribe();
          }, [user]);

          // Audio
          useEffect(() => {
            if (audioRef.current) {
                audioRef.current.src = MUSIC_PLAYLIST[trackIndex].url;
                if (musicEnabled) {
                    audioRef.current.volume = 0.3;
                    audioRef.current.play().catch(e => console.log("Audio failed", e));
                } else {
                    audioRef.current.pause();
                }
            }
          }, [musicEnabled, trackIndex]);

          const saveData = async (updates) => {
            if (!user || !db) return;
            try {
              const userDocRef = doc(db, 'artifacts', appId, 'users', user.uid, 'data', 'gameProgress');
              await setDoc(userDocRef, updates, { merge: true });
            } catch (e) { }
          };

          const addXp = (amount) => {
            const oldRank = getCurrentRank();
            const newXp = xp + amount;
            const newRank = [...RANKS].reverse().find(r => newXp >= r.xp) || RANKS[0];
            let leveledUp = false;
            if (newRank.level > oldRank.level) {
              leveledUp = true;
              setLevelUp(newRank);
              setShowConfetti(true);
              setTimeout(() => setShowConfetti(false), 3000);
            }
            return { newXp: newXp, newLevel: newRank.level };
          };

          const checkAchievements = (newStats = {}) => {
            const currentStats = {
              streak: newStats.streak !== undefined ? newStats.streak : streak,
              totalCoins: newStats.totalCoins !== undefined ? newStats.totalCoins : totalCoins,
              solved: newStats.solved !== undefined ? newStats.solved : solvedCount,
              level: newStats.level !== undefined ? newStats.level : getCurrentRank().level,
              inventoryCount: inventory.length,
              stickerCount: stickers.length
            };
            const newUnlockedStickers = [];
            STICKERS.forEach(s => {
              if (!stickers.includes(s.id) && !newUnlockedStickers.includes(s.id) && s.condition && s.condition(currentStats, equippedTheme)) {
                newUnlockedStickers.push(s.id);
                setNewUnlock(s);
                setTimeout(() => setNewUnlock(null), 4000);
              }
            });
            return newUnlockedStickers;
          };

          const generateProblem = (type, isDaily = false) => {
            setUserVisualState(0);
            setUserAnswer('');
            setFeedback(null);
            setLevelUp(null);
            setDecoratorGrid([]);
            setSnackState({ plates: [], pool: 0 });
            setOvenState([]);
            setAnimationStep(0);

            // Difficulty Scaling based on Rank Level or Daily (Daily = Hard)
            const currentLevel = isDaily ? 6 : getCurrentRank().level;
            const diffMult = Math.ceil(currentLevel * 1.5); // Scales range approx 2 to 11

            if (type === 'frac-mult-frac') {
              const maxDen = Math.min(12, 4 + diffMult); // Cap denominator at 12
              const den1 = Math.floor(Math.random() * (maxDen - 2)) + 2; 
              const num1 = Math.floor(Math.random() * (den1 - 1)) + 1;
              const den2 = Math.floor(Math.random() * (maxDen - 2)) + 2; 
              const num2 = Math.floor(Math.random() * (den2 - 1)) + 1;
              
              const grid = Array(den1 * den2).fill(false);
              setDecoratorGrid(grid);
              setCurrentProblem({ type: 'frac-mult-frac', num1, den1, num2, den2, ansNum: num1 * num2, ansDen: den1 * den2, isDaily });
            }
            else if (type === 'cake-decorator') {
              // Increased variety base: 4 + level/2. Level 1 = 4 (dens 2-4). Allows non-unit fractions immediately.
              const maxGrid = Math.min(8, 4 + Math.floor(currentLevel/2)); 
              
              const den1 = Math.floor(Math.random() * (maxGrid - 2)) + 2; 
              const den2 = Math.floor(Math.random() * (maxGrid - 2)) + 2; 
              
              // Ensure proper fractions (numerator < denominator)
              const num1 = Math.floor(Math.random() * (den1 - 1)) + 1;
              const num2 = Math.floor(Math.random() * (den2 - 1)) + 1;
              
              const grid = Array(den1 * den2).fill(false);
              setDecoratorGrid(grid);
              setCurrentProblem({ 
                type: 'cake-decorator', num1, den1, num2, den2, 
                targetCount: num1 * num2, 
                text: `Decorate the cake so ${num1}/${den1} is chocolate, and ${num2}/${den2} of that section has sprinkles.`,
                isDaily 
              });
            }
            else if (type === 'snack-sharing') {
               const maxPlates = Math.min(8, 2 + currentLevel);
               const maxPerPlate = Math.min(10, 2 + diffMult);
               const plates = Math.floor(Math.random() * (maxPlates - 2)) + 2; 
               const perPlate = Math.floor(Math.random() * (maxPerPlate - 1)) + 1; 
               const total = plates * perPlate;
               setSnackState({ plates: Array(plates).fill(0), pool: total });
               setCurrentProblem({ type: 'snack-sharing', total, plates, perPlate, answer: perPlate, isDaily });
            }
            else if (type === 'whole-div-unit') {
              const maxWhole = 2 + diffMult;
              const whole = Math.floor(Math.random() * (maxWhole - 2)) + 2; 
              const den = Math.floor(Math.random() * 4) + 2;   
              setOvenState(Array(whole).fill(false)); // Initialize cake states
              setCurrentProblem({ type: 'whole-div-unit', whole, den, answer: whole * den, isDaily });
            } 
            else if (type === 'unit-div-whole') {
              const startDen = Math.floor(Math.random() * 4) + 2; 
              const maxDiv = 2 + Math.floor(currentLevel * 1.5);
              const divisor = Math.floor(Math.random() * (maxDiv - 2)) + 2; 
              setOvenState([false]); // Initialize single slice state
              setCurrentProblem({ type: 'unit-div-whole', startNum: 1, startDen, divisor, answerDen: startDen * divisor, isDaily });
            }
            else if (type === 'word-match') {
              const category = PROBLEM_TEMPLATES[Math.floor(Math.random() * PROBLEM_TEMPLATES.length)];
              const templateStr = category.templates[Math.floor(Math.random() * category.templates.length)];
              const A = Math.floor(Math.random() * (3 + diffMult)) + 2; 
              const den = Math.floor(Math.random() * 5) + 2; 
              const num = Math.floor(Math.random() * (den-1)) + 1; 
              const F = `${num}/${den}`;
              let displayText = templateStr.replace('{A}', A).replace('{F}', F);
              let correct, options;
              
              if (category.type === 'whole-first') {
                correct = `${A} ÷ ${F}`;
                options = [`${A} ÷ ${F}`, `${F} ÷ ${A}`, `${A} × ${F}`];
              } else if (category.type === 'frac-first') {
                correct = `${F} ÷ ${A}`;
                options = [`${F} ÷ ${A}`, `${F} × ${A}`, `${A} ÷ ${F}`];
              } else {
                correct = `${A} × ${F}`;
                options = [`${A} × ${F}`, `${A} ÷ ${F}`, `${A} + ${F}`];
              }
              // Randomly assign options to prevent position bias
              options = options.sort(() => Math.random() - 0.5);
              setCurrentProblem({ type: 'word-match', text: displayText, correct: correct, options: options, isDaily });
            }
            else if (type === 'comparison') {
               const mode = Math.random();
               let start, label, logic;
               const range = 5 + (currentLevel * 5); // Larger numbers at higher ranks
               if (mode < 0.5) {
                   start = Math.floor(Math.random() * range) + 2;
                   const den = Math.floor(Math.random() * 5) + 2;
                   label = `${start} ÷ 1/${den}`;
                   logic = 'greater';
               } else {
                   start = Math.floor(Math.random() * range) + 2;
                   const den = Math.floor(Math.random() * 4) + 2;
                   const num = Math.floor(Math.random() * (den - 1)) + 1;
                   label = `${start} × ${num}/${den}`;
                   logic = 'less';
               }
               setCurrentProblem({ type: 'comparison', start: start, label: label, logic: logic, isDaily });
            }
          };

          const handleStartGame = (type, isDaily = false) => {
            setGameType(type);
            setMode('game');
            setStreak(0);
            setMissedStreak(0);
            generateProblem(type, isDaily);
          };

          // DAILY CHALLENGE LOGIC
          const startDailyChallenge = () => {
             const today = new Date().toDateString();
             if (dailyChallenge.lastCompleted === today) return;
             
             // Pick random hard problem type
             const types = Object.keys(STATION_COSTS);
             const randomType = types[Math.floor(Math.random() * types.length)];
             
             handleStartGame(randomType, true);
          };

          const handleDecoratorClick = (index) => {
             const newGrid = [...decoratorGrid];
             newGrid[index] = !newGrid[index];
             setDecoratorGrid(newGrid);
          };
          
          const handleOvenClick = (index) => {
             const newOven = [...ovenState];
             newOven[index] = !newOven[index]; // Toggle cut state
             setOvenState(newOven);
          };

          const handleSnackClick = () => {
             if (snackState.pool > 0) {
                 const targetIndex = (currentProblem.total - snackState.pool) % currentProblem.plates;
                 const newPlates = [...snackState.plates];
                 newPlates[targetIndex]++;
                 setSnackState({ plates: newPlates, pool: snackState.pool - 1 });
             }
          };

          const handleFeedPet = () => {
              if (coins >= 50) {
                  const newCoins = coins - 50;
                  const newPetXp = petXp + 50;
                  setCoins(newCoins);
                  setPetXp(newPetXp);
                  setIsPetEating(true);
                  setTimeout(() => setIsPetEating(false), 500);

                  // Level up logic
                  let newLevel = 1;
                  if (newPetXp > 100) newLevel = 2;
                  if (newPetXp > 300) newLevel = 3;
                  if (newPetXp > 600) newLevel = 4;
                  if (newPetXp > 1000) newLevel = 5;
                  if (newPetXp > 1500) newLevel = 6;
                  
                  if (newLevel > petLevel) {
                      setPetLevel(newLevel);
                      setShowConfetti(true);
                      setTimeout(() => setShowConfetti(false), 3000);
                  }

                  saveData({ coins: newCoins, petXp: newPetXp, petLevel: newLevel });
              }
          };

          const checkAnswer = (input) => {
            if(feedback) return;
            let isCorrect = false;
            let explanation = "";
            
            if (currentProblem.type === 'cake-decorator') {
                const selectedCount = decoratorGrid.filter(Boolean).length;
                if (selectedCount === currentProblem.targetCount) isCorrect = true;
                explanation = `We need ${currentProblem.num1}/${currentProblem.den1} of the cake, then ${currentProblem.num2}/${currentProblem.den2} of that part. Multiply: ${currentProblem.num1}*${currentProblem.num2} = ${currentProblem.targetCount} squares total.`;
            }
            else if (currentProblem.type === 'snack-sharing') {
                if (parseInt(input) === currentProblem.perPlate) isCorrect = true;
                explanation = `${currentProblem.total} pretzels shared by ${currentProblem.plates} plates is ${currentProblem.total} ÷ ${currentProblem.plates} = ${currentProblem.perPlate}.`;
            }
            else if (currentProblem.type === 'frac-mult-frac') {
              // Validate specific overlap area
              const isPatternCorrect = decoratorGrid.every((isSelected, i) => {
                  const col = i % currentProblem.den1;
                  const row = Math.floor(i / currentProblem.den1);
                  const isOverlap = col < currentProblem.num1 && row < currentProblem.num2;
                  return isSelected === isOverlap;
              });
              
              if (isPatternCorrect) isCorrect = true;
              explanation = `Multiply the tops: ${currentProblem.num1} × ${currentProblem.num2} = ${currentProblem.ansNum}. Multiply the bottoms: ${currentProblem.den1} × ${currentProblem.den2} = ${currentProblem.ansDen}. You must highlight exactly where the rows and columns overlap!`;
            } else if (currentProblem.type === 'whole-div-unit') {
              if (parseInt(input) === currentProblem.answer) isCorrect = true;
              explanation = `Each cake has ${currentProblem.den} slices. ${currentProblem.whole} cakes × ${currentProblem.den} = ${currentProblem.answer} total slices.`;
            } else if (currentProblem.type === 'unit-div-whole') {
              const [uNum, uDen] = input.split('/').map(n => parseInt(n));
              if (uNum === 1 && uDen === currentProblem.answerDen) isCorrect = true;
              explanation = `Splitting a 1/${currentProblem.startDen} slice into ${currentProblem.divisor} tiny pieces makes them 1/(${currentProblem.startDen} × ${currentProblem.divisor}) = 1/${currentProblem.answerDen} size.`;
            } else if (currentProblem.type === 'word-match') {
              if (input === currentProblem.correct) isCorrect = true;
              explanation = "Check who is being shared! If items are shared by people, it's Item ÷ People. If we take a part of a part, it's Multiply.";
            } else if (currentProblem.type === 'comparison') {
              if (input === currentProblem.logic) isCorrect = true;
              explanation = "When dividing by a fraction less than 1, the number gets bigger! When multiplying by a fraction less than 1, it gets smaller.";
            }

            if (isCorrect) {
              const currentLevel = getCurrentRank().level;
              // Adjusted Economy: Base Pay increases with Rank
              const levelBasePay = 2 + (currentLevel * 3); // Level 1 = 5 coins, Level 7 = 23 coins
              const streakBonus = Math.min(streak * 2, 20); // Cap streak bonus at 20 coins
              let earnedCoins = levelBasePay + streakBonus;
              
              if (currentProblem.isDaily) {
                  earnedCoins += 50; // Daily Bonus
              }
              
              const newStreak = streak + 1;
              const newTotalCoins = totalCoins + earnedCoins;
              const newSolved = solvedCount + 1;
              const newCoins = coins + earnedCoins;
              const { newXp, newLevel } = addXp(100 + (streak * 5)); // Bonus XP for streaks
              
              // Check achievements
              const unlockedStickers = checkAchievements({ streak: newStreak, totalCoins: newTotalCoins, solved: newSolved, level: newLevel });
              const newStickers = [...stickers, ...unlockedStickers];

              setCoins(newCoins);
              setTotalCoins(newTotalCoins);
              setStreak(newStreak);
              setMissedStreak(0); // Reset missed streak on correct answer
              setSolvedCount(newSolved);
              setXp(newXp);
              setStickers(newStickers);
              
              if (currentProblem.isDaily) {
                  const today = new Date().toDateString();
                  setDailyChallenge({ lastCompleted: today });
                  setFeedback({ type: 'success', message: `DAILY COMPLETE! +${earnedCoins} Coins`, explanation });
                  saveData({ dailyChallenge: { lastCompleted: today } });
              } else {
                  setFeedback({ type: 'success', message: `Correct! +${earnedCoins} Coins`, explanation });
              }
              
              // Visuals
              setShowSparkles(true);
              setTimeout(() => setShowSparkles(false), 800);
              setIsPetHappy(true);
              setTimeout(() => setIsPetHappy(false), 2000);
              
              saveData({ coins: newCoins, totalCoins: newTotalCoins, streak: newStreak, solvedCount: newSolved, xp: newXp, stickers: newStickers });
            } else {
              const newMissed = missedStreak + 1;
              setMissedStreak(newMissed);
              setStreak(0);
              
              // Demotion Logic
              const currentRankData = getCurrentRank();
              const rankIndex = RANKS.findIndex(r => r.level === currentRankData.level);
              
              // If we miss 3 in a row AND we are not at the lowest rank
              if (newMissed >= 3 && rankIndex > 0) {
                 const prevRank = RANKS[rankIndex - 1];
                 setXp(prevRank.xp); // Demote to start of previous rank
                 setMissedStreak(0);
                 setFeedback({ type: 'error', message: `Too many mistakes! Demoted to ${prevRank.title}.`, explanation: "Don't give up! Review the concepts and climb back up." });
                 saveData({ streak: 0, xp: prevRank.xp });
              } else {
                 const warning = rankIndex > 0 ? ` ${3 - newMissed} chances left!` : '';
                 setFeedback({ type: 'error', message: `Not quite!${warning}`, explanation: explanation + " Review the explanation above and try again!" });
                 saveData({ streak: 0 });
              }
            }
          };

          const renderConfetti = () => {
             if (!showConfetti) return null;
             return React.createElement("div", { className: "fixed inset-0 pointer-events-none z-50" },
               Array.from({length: 30}).map((_, i) => React.createElement("div", { key: i, className: "absolute w-3 h-3 rounded-full animate-confetti", style: {
                   left: `${Math.random()*100}vw`, top: '-10px', 
                   backgroundColor: ['#FFD700', '#FF69B4', '#00E676', '#00B0FF'][i%4],
                   animationDuration: `${1+Math.random()*2}s`
               }}))
             );
          };
          
          const renderSparkles = () => {
             if (!showSparkles) return null;
             return React.createElement("div", { className: "absolute inset-0 pointer-events-none z-50 flex items-center justify-center" },
               Array.from({length: 8}).map((_, i) => React.createElement("div", { key: i, className: "absolute w-6 h-6 animate-sparkle", style: {
                   left: `calc(50% + ${(Math.random()-0.5)*200}px)`, 
                   top: `calc(50% + ${(Math.random()-0.5)*200}px)`, 
                   animationDelay: `${i*0.1}s`
               }}, React.createElement(Star, { className: "text-yellow-400 fill-yellow-400" })))
             );
          };

          const buyCrate = () => {
             const CRATE_COST = 200;
             if (coins < CRATE_COST) return;
             const newCoins = coins - CRATE_COST;
             setCoins(newCoins);
             setIsOpeningCrate(true);
             setTimeout(() => {
                const availableThemes = Object.keys(THEMES).filter(id => !inventory.includes(id));
                const commonStickers = STICKERS.filter(s => s.rarity === 'common' && !stickers.includes(s.id));
                const availableRecipes = Object.keys(RECIPES).filter(id => !unlockedRecipes.includes(id));

                let reward = null;
                let newInventory = [...inventory];
                let newStickers = [...stickers];
                let newRecipes = [...unlockedRecipes];
                let finalCoins = newCoins;
                
                const roll = Math.random();
                
                // Drop Logic with Rarity Weighting for Themes
                if (availableThemes.length > 0 && roll > 0.4) { // 60% chance for theme if available
                    // Rarity Weights:
                    // Common: 100, Uncommon: 60, Rare: 30, Epic: 10, Legendary: 5, Mythic: 1
                    const weightedThemes = [];
                    availableThemes.forEach(id => {
                        const theme = THEMES[id];
                        let weight = 100;
                        if (theme.rarity === 'uncommon') weight = 60;
                        if (theme.rarity === 'rare') weight = 30;
                        if (theme.rarity === 'epic') weight = 10;
                        if (theme.rarity === 'legendary') weight = 5;
                        if (theme.rarity === 'mythic') weight = 1; // Very rare
                        
                        for(let i=0; i<weight; i++) weightedThemes.push(id);
                    });
                    
                    const randomTheme = weightedThemes[Math.floor(Math.random() * weightedThemes.length)];
                    newInventory.push(randomTheme);
                    reward = { type: 'theme', ...THEMES[randomTheme] };
                    setInventory(newInventory);
                    setPreviewTheme(randomTheme);
                } else if (availableRecipes.length > 0 && roll > 0.2) { // 20% chance for recipe
                    const randomRecipe = availableRecipes[Math.floor(Math.random() * availableRecipes.length)];
                    newRecipes.push(randomRecipe);
                    reward = { type: 'recipe', ...RECIPES[randomRecipe] };
                    setUnlockedRecipes(newRecipes);
                } else if (commonStickers.length > 0 && roll > 0.05) { // 15% chance for sticker
                    const randomSticker = commonStickers[Math.floor(Math.random() * commonStickers.length)];
                    newStickers.push(randomSticker.id);
                    reward = { type: 'sticker', ...randomSticker };
                    setStickers(newStickers);
                } else { // 5% chance for refund
                    finalCoins += 50;
                    setCoins(finalCoins);
                    reward = { type: 'coins', name: '50 Coins (Refund)', icon: React.createElement(ShoppingBag, {size:40}) };
                }
                
                setCrateReward(reward);
                setIsOpeningCrate(false);
                setShowConfetti(true);
                setTimeout(() => setShowConfetti(false), 3000);
                saveData({ coins: finalCoins, inventory: newInventory, stickers: newStickers, unlockedRecipes: newRecipes });
             }, 2000);
          };

          const handleEquipTheme = (themeId) => {
             setEquippedTheme(themeId);
             saveData({ equippedTheme: themeId });
          };
          const handleEquipSticker = (stickerId) => {
             const newSticker = equippedSticker === stickerId ? null : stickerId;
             setEquippedSticker(newSticker);
             saveData({ equippedSticker: newSticker });
          };
          
          const handleUnlockStation = (stationId) => {
              const cost = STATION_COSTS[stationId];
              if (coins >= cost) {
                  const newCoins = coins - cost;
                  const newUnlocked = [...unlockedStations, stationId];
                  setCoins(newCoins);
                  setUnlockedStations(newUnlocked);
                  setShowSparkles(true);
                  setTimeout(() => setShowSparkles(false), 1000);
                  saveData({ coins: newCoins, unlockedStations: newUnlocked });
              }
          };
          
          // --- CHEF GEAR HANDLERS ---
          const handleBuyHat = (hatId) => {
              const hat = HATS[hatId];
              if (coins >= hat.cost && !hats.includes(hatId)) {
                  const newCoins = coins - hat.cost;
                  const newHats = [...hats, hatId];
                  setCoins(newCoins);
                  setHats(newHats);
                  setEquippedHat(hatId);
                  setShowSparkles(true);
                  setTimeout(() => setShowSparkles(false), 1000);
                  saveData({ coins: newCoins, hats: newHats, equippedHat: hatId });
              } else if (hats.includes(hatId)) {
                  setEquippedHat(hatId);
                  saveData({ equippedHat: hatId });
              }
          };

          const handleBuyTool = (toolId) => {
              const tool = TOOLS[toolId];
              if (coins >= tool.cost && !tools.includes(toolId)) {
                  const newCoins = coins - tool.cost;
                  const newTools = [...tools, toolId];
                  setCoins(newCoins);
                  setTools(newTools);
                  setEquippedTool(toolId);
                  setShowSparkles(true);
                  setTimeout(() => setShowSparkles(false), 1000);
                  saveData({ coins: newCoins, tools: newTools, equippedTool: toolId });
              } else if (tools.includes(toolId)) {
                  setEquippedTool(toolId);
                  saveData({ equippedTool: toolId });
              }
          };

          const handleBuyApron = (apronId) => {
              const apron = APRONS[apronId];
              if (coins >= apron.cost && !aprons.includes(apronId)) {
                  const newCoins = coins - apron.cost;
                  const newAprons = [...aprons, apronId];
                  setCoins(newCoins);
                  setAprons(newAprons);
                  setEquippedApron(apronId);
                  setShowSparkles(true);
                  setTimeout(() => setShowSparkles(false), 1000);
                  saveData({ coins: newCoins, aprons: newAprons, equippedApron: apronId });
              } else if (aprons.includes(apronId)) {
                  setEquippedApron(apronId);
                  saveData({ equippedApron: apronId });
              }
          };

          // --- RENOVATION HANDLERS ---
          const handleBuyBackground = (bgId) => {
              const item = BACKGROUNDS[bgId];
              if (coins >= item.cost && !backgrounds.includes(bgId)) {
                  const newCoins = coins - item.cost;
                  const newBgs = [...backgrounds, bgId];
                  setCoins(newCoins);
                  setBackgrounds(newBgs);
                  setEquippedBackground(bgId);
                  setShowSparkles(true);
                  setTimeout(() => setShowSparkles(false), 1000);
                  saveData({ coins: newCoins, backgrounds: newBgs, equippedBackground: bgId });
              } else if (backgrounds.includes(bgId)) {
                  setEquippedBackground(bgId);
                  saveData({ equippedBackground: bgId });
              }
          };

          const handleBuyCountertop = (ctId) => {
              const item = COUNTERTOPS[ctId];
              if (coins >= item.cost && !countertops.includes(ctId)) {
                  const newCoins = coins - item.cost;
                  const newCts = [...countertops, ctId];
                  setCoins(newCoins);
                  setCountertops(newCts);
                  setEquippedCountertop(ctId);
                  setShowSparkles(true);
                  setTimeout(() => setShowSparkles(false), 1000);
                  saveData({ coins: newCoins, countertops: newCts, equippedCountertop: ctId });
              } else if (countertops.includes(ctId)) {
                  setEquippedCountertop(ctId);
                  saveData({ equippedCountertop: ctId });
              }
          };

          const handleBuyDecoration = (decId) => {
              const item = DECORATIONS[decId];
              if (coins >= item.cost && !decorations.includes(decId)) {
                  const newCoins = coins - item.cost;
                  const newDecs = [...decorations, decId];
                  setCoins(newCoins);
                  setDecorations(newDecs);
                  setShowSparkles(true);
                  setTimeout(() => setShowSparkles(false), 1000);
                  saveData({ coins: newCoins, decorations: newDecs });
              }
          };

          // --- PET SHOP HANDLERS ---
          const handleBuyPetSkin = (skinId) => {
              const item = PET_SKINS[skinId];
              // Logic handles both Buying and Equipping
              if (coins >= item.cost && !petSkins.includes(skinId)) {
                  const newCoins = coins - item.cost;
                  const newSkins = [...petSkins, skinId];
                  setCoins(newCoins);
                  setPetSkins(newSkins);
                  setEquippedPetSkin(skinId);
                  setShowSparkles(true);
                  setTimeout(() => setShowSparkles(false), 1000);
                  saveData({ coins: newCoins, petSkins: newSkins, equippedPetSkin: skinId });
              } else if (petSkins.includes(skinId)) {
                  setEquippedPetSkin(skinId);
                  saveData({ equippedPetSkin: skinId });
              }
          };

          const handleBuyPetHat = (hatId) => {
              const item = PET_HATS[hatId];
              // Logic handles both Buying and Equipping
              if (coins >= item.cost && !petHats.includes(hatId)) {
                  const newCoins = coins - item.cost;
                  const newHats = [...petHats, hatId];
                  setCoins(newCoins);
                  setPetHats(newHats);
                  setEquippedPetHat(hatId);
                  setShowSparkles(true);
                  setTimeout(() => setShowSparkles(false), 1000);
                  saveData({ coins: newCoins, petHats: newHats, equippedPetHat: hatId });
              } else if (petHats.includes(hatId)) {
                  setEquippedPetHat(hatId);
                  saveData({ equippedPetHat: hatId });
              }
          };
          
          const toggleMusic = () => setMusicEnabled(!musicEnabled);
          const nextTrack = () => setTrackIndex((trackIndex + 1) % MUSIC_PLAYLIST.length);

          const handleSaveGame = () => {
             const saveData = {
                coins, totalCoins, xp, inventory, stickers, equippedTheme, equippedSticker, streak, solvedCount, dailyChallenge, unlockedStations,
                hats, tools, aprons, equippedHat, equippedTool, equippedApron,
                backgrounds, countertops, decorations, equippedBackground, equippedCountertop,
                petXp, petLevel, unlockedRecipes,
                petSkins, petHats, equippedPetSkin, equippedPetHat
             }; 
             const blob = new Blob([JSON.stringify(saveData)], {type: "application/json"});
             const url = URL.createObjectURL(blob);
             const link = document.createElement('a');
             link.href = url;
             link.download = `bakery-boss-save-${new Date().toISOString().slice(0,10)}.json`;
             document.body.appendChild(link);
             link.click();
             document.body.removeChild(link);
             setShowSettings(false);
          };

          const handleLoadGame = (event) => {
             const file = event.target.files[0];
             if (!file) return;
             const reader = new FileReader();
             reader.onload = (e) => {
                try {
                   const data = JSON.parse(e.target.result);
                   if (data.coins !== undefined) setCoins(data.coins);
                   if (data.totalCoins !== undefined) setTotalCoins(data.totalCoins);
                   if (data.xp !== undefined) setXp(data.xp);
                   if (data.inventory) setInventory(data.inventory);
                   if (data.stickers) setStickers(data.stickers);
                   if (data.equippedTheme) setEquippedTheme(data.equippedTheme);
                   if (data.equippedSticker) setEquippedSticker(data.equippedSticker);
                   if (data.streak !== undefined) setStreak(data.streak);
                   if (data.solvedCount !== undefined) setSolvedCount(data.solvedCount);
                   if (data.dailyChallenge) setDailyChallenge(data.dailyChallenge);
                   if (data.unlockedStations) setUnlockedStations(data.unlockedStations);
                   if (data.hats) setHats(data.hats);
                   if (data.tools) setTools(data.tools);
                   if (data.aprons) setAprons(data.aprons);
                   if (data.equippedHat) setEquippedHat(data.equippedHat);
                   if (data.equippedTool) setEquippedTool(data.equippedTool);
                   if (data.equippedApron) setEquippedApron(data.equippedApron);
                   if(data.backgrounds) setBackgrounds(data.backgrounds);
                   if(data.countertops) setCountertops(data.countertops);
                   if(data.decorations) setDecorations(data.decorations);
                   if(data.equippedBackground) setEquippedBackground(data.equippedBackground);
                   if(data.equippedCountertop) setEquippedCountertop(data.equippedCountertop);
                   if(data.petXp !== undefined) setPetXp(data.petXp);
                   if(data.petLevel !== undefined) setPetLevel(data.petLevel);
                   if(data.unlockedRecipes) setUnlockedRecipes(data.unlockedRecipes);
                   
                   // Close settings and show success
                   setShowSettings(false);
                   setShowConfetti(true);
                   setTimeout(() => setShowConfetti(false), 2000);
                } catch (err) {
                   console.error("Failed to load save", err);
                }
             };
             reader.readAsText(file);
          };

          // --- RENDER HELPERS ---
          const renderProblem = () => {
             // ... (Existing renderProblem function logic remains identical)
             if (!currentProblem) return null;
             
             switch(currentProblem.type) {
                 case 'cake-decorator':
                     return React.createElement("div", { className: "flex flex-col items-center w-full" },
                        React.createElement("div", { className: "mb-6 bg-slate-900 px-6 py-4 rounded-xl border-l-4 border-pink-500 text-lg text-slate-200 shadow-lg" }, 
                           React.createElement("span", { className: "font-bold text-pink-400 block mb-1" }, "CUSTOM ORDER:"),
                           currentProblem.text
                        ),
                        React.createElement("div", { className: "grid gap-1 bg-slate-800 p-2 rounded-xl shadow-inner", style: { gridTemplateColumns: `repeat(${currentProblem.den1}, 1fr)` } },
                             decoratorGrid.map((active, i) => 
                                React.createElement("button", { 
                                   key: i, 
                                   onClick: () => handleDecoratorClick(i),
                                   className: `w-16 h-16 border-2 transition-all rounded-md ${active ? 'border-white scale-95 ring-2 ring-pink-500' : 'border-slate-600 hover:bg-slate-700'}`
                                }, 
                                   React.createElement("svg", { width: "100%", height: "100%", className: "rounded" },
                                      React.createElement("rect", { width: "100%", height: "100%", fill: active ? t.fill : 'transparent' })
                                   )
                                )
                             )
                        ),
                        React.createElement("p", { className: "mt-4 text-slate-400 text-sm font-bold animate-pulse" }, "Tap squares to decorate!")
                     );

                 case 'snack-sharing':
                     return React.createElement("div", { className: "flex flex-col items-center w-full" },
                          React.createElement("div", { className: "mb-8 bg-slate-900 px-8 py-4 rounded-2xl border-b-4 border-slate-700 shadow-lg text-2xl font-black text-white" }, 
                              `Share ${currentProblem.total} pretzels among ${currentProblem.plates} plates.`
                          ),
                          React.createElement("div", { className: "relative w-32 h-32 mb-8" },
                             React.createElement("button", { onClick: handleSnackClick, className: "absolute inset-0 flex items-center justify-center bg-slate-700 rounded-full border-4 border-slate-500 hover:scale-105 active:scale-95 transition-transform shadow-xl" },
                                snackState.pool > 0 ? 
                                    React.createElement("div", { className: "text-center" }, 
                                        React.createElement(Cookie, { size: 48, className: "text-orange-400 mx-auto drop-shadow-md" }),
                                        React.createElement("div", { className: "font-black text-xl mt-1" }, snackState.pool)
                                    ) : 
                                    React.createElement("div", { className: "text-slate-500 italic font-bold" }, "Empty")
                             )
                          ),
                          React.createElement("div", { className: "flex gap-4 justify-center w-full flex-wrap" },
                             snackState.plates.map((count, i) => 
                                React.createElement("div", { key: i, className: "w-32 h-32 bg-white/5 rounded-full border-4 border-white/20 flex flex-wrap content-center justify-center gap-1 p-4 relative" },
                                   Array.from({length: count}).map((_, j) => React.createElement(Cookie, { key: j, size: 20, className: "text-orange-400 animate-in zoom-in" })),
                                   React.createElement("div", { className: "absolute -bottom-8 font-bold text-slate-400 bg-slate-900 px-3 py-1 rounded-full text-xs" }, `Plate ${i+1}: ${count}`)
                                )
                             )
                          )
                     );

                 case 'whole-div-unit':
                 case 'unit-div-whole':
                     const isWholeDiv = currentProblem.type === 'whole-div-unit';
                     return React.createElement("div", { className: "flex flex-col items-center w-full" },
                          React.createElement("div", { className: "mb-8 bg-slate-900 px-8 py-4 rounded-2xl border-b-4 border-slate-700 shadow-lg text-2xl font-black text-white text-center" },
                             isWholeDiv ? `Count slices: ${currentProblem.whole} cakes divided into ${currentProblem.den} slices each.` :
                             `Divide 1/${currentProblem.startDen} of a cake into ${currentProblem.divisor} smaller pieces.`
                          ),
                          React.createElement("div", { className: "flex flex-wrap justify-center gap-8 mb-8" },
                             isWholeDiv ? 
                              Array.from({length: currentProblem.whole}).map((_, i) => 
                                React.createElement("div", { key: i },
                                   React.createElement(Render3DCake, { 
                                      type: "round", 
                                      pieces: ovenState[i] ? currentProblem.den : 0, 
                                      themeId: equippedTheme,
                                      interactive: true,
                                      onClick: () => handleOvenClick(i)
                                   })
                                )
                              ) :
                              React.createElement("div", { className: "relative w-64 h-40" },
                                     React.createElement(Render3DCake, { 
                                        type: "rect", 
                                        pieces: currentProblem.startDen, 
                                        themeId: equippedTheme,
                                        interactive: true,
                                        onClick: () => handleOvenClick(0)
                                     }),
                                     React.createElement("div", { className: "absolute inset-0 top-[10%] left-[5%] w-[90%] h-[80%] pointer-events-none" },
                                       React.createElement("svg", { width: "100%", height: "100%" },
                                         Array.from({length: currentProblem.startDen}).map((_, i) => {
                                            const w = 100/currentProblem.startDen;
                                            return React.createElement("g", { key: i },
                                               i===0 && React.createElement("rect", { x: "0", y: "0", width: `${w}%`, height: "100%", fill: "none", stroke: "white", strokeWidth: "3", strokeDasharray: "4 4", className: "animate-pulse", opacity: "0.8" }),
                                               i===0 && ovenState[0] && Array.from({length: currentProblem.divisor}).map((_, j) => (
                                                   React.createElement("line", { key: j, x1: "0", y1: `${(j+1)*(100/currentProblem.divisor)}%`, x2: `${w}%`, y2: `${(j+1)*(100/currentProblem.divisor)}%`, stroke: "white", strokeWidth: "2", strokeDasharray: "2 2" })
                                               ))
                                            )
                                         })
                                       )
                                     )
                                  )
                          ),
                          React.createElement("p", { className: "text-slate-400 mb-8 font-medium animate-in fade-in" }, "Click the cake to cut!")
                     );
                 
                 case 'word-match':
                     return React.createElement("div", { className: "flex flex-col items-center w-full max-w-3xl" },
                         React.createElement("div", { className: "bg-slate-700 p-8 rounded-2xl mb-8 text-center text-xl font-medium border border-slate-600 shadow-xl leading-relaxed relative" }, 
                            React.createElement("div", { className: "absolute -top-4 left-1/2 -translate-x-1/2 bg-yellow-500 text-black px-4 py-1 rounded-full font-bold text-sm uppercase" }, "Customer Order"),
                            `"${currentProblem.text}"`
                         ),
                         React.createElement("div", { className: "flex gap-6 justify-center w-full flex-wrap" },
                             currentProblem.options.map((opt, i) => 
                                React.createElement("button", { key: i, onClick: () => checkAnswer(opt), className: "bg-white text-slate-900 w-64 h-80 rounded-sm shadow-xl p-6 flex flex-col items-center transform hover:-translate-y-2 transition-all relative overflow-hidden group" },
                                   React.createElement("div", { className: "border-b-2 border-dashed border-slate-300 w-full pb-4 mb-4 text-center font-mono text-sm text-slate-500" }, "BAKERY RECEIPT"),
                                   React.createElement("div", { className: "flex-grow flex items-center justify-center" },
                                      React.createElement("div", { className: "text-3xl font-black font-mono" }, opt)
                                   ),
                                   React.createElement("div", { className: "mt-4 pt-4 border-t-2 border-slate-200 w-full flex justify-between text-xs font-mono text-slate-400" },
                                      React.createElement("span", null, "ITEM: 1"),
                                      React.createElement("span", null, "TOTAL: $--")
                                   ),
                                   React.createElement("div", { className: "absolute inset-0 bg-blue-500/10 opacity-0 group-hover:opacity-100 transition-opacity flex items-center justify-center" },
                                      React.createElement("div", { className: "bg-blue-600 text-white px-6 py-2 rounded-full font-bold transform -rotate-12 shadow-lg border-2 border-white" }, "STAMP")
                                   )
                                )
                             )
                         )
                     );

                 case 'comparison':
                     return React.createElement("div", { className: "flex flex-col items-center w-full" },
                         React.createElement("div", { className: "flex items-center gap-6 text-2xl md:text-4xl font-black mb-12 bg-slate-800 p-8 rounded-3xl shadow-inner border border-slate-700" },
                            React.createElement("span", { className: "text-white" }, currentProblem.label),
                            React.createElement("div", { className: "w-16 h-16 bg-slate-900 rounded-xl flex items-center justify-center border-b-4 border-black text-yellow-400" }, "?"),
                            React.createElement("span", { className: "text-white" }, currentProblem.start)
                         ),
                         React.createElement("div", { className: "flex gap-8" },
                            React.createElement("button", { onClick: () => checkAnswer('less'), className: "bg-red-900/40 hover:bg-red-600 border-2 border-red-500 hover:border-red-400 text-red-100 font-bold w-32 h-32 rounded-2xl flex flex-col items-center justify-center gap-2 transition-all transform hover:scale-105" }, 
                                React.createElement(XCircle, { size: 32 }), "LESS"
                            ),
                            React.createElement("button", { onClick: () => checkAnswer('greater'), className: "bg-green-900/40 hover:bg-green-600 border-2 border-green-500 hover:border-green-400 text-green-100 font-bold w-32 h-32 rounded-2xl flex flex-col items-center justify-center gap-2 transition-all transform hover:scale-105" }, 
                                React.createElement(CheckCircle, { size: 32 }), "GREATER"
                            )
                         )
                     );

                 default: // Prep Station (frac-mult-frac)
                     return React.createElement("div", { className: "flex flex-col items-center w-full" },
                         React.createElement("div", { className: "mb-8 bg-slate-900 px-8 py-4 rounded-2xl border-b-4 border-slate-700 shadow-lg text-2xl font-black text-white" },
                            React.createElement("span", { className: "text-blue-400" }, `${currentProblem.num1}/${currentProblem.den1}`),
                            " × ",
                            React.createElement("span", { className: "text-red-400" }, `${currentProblem.num2}/${currentProblem.den2}`),
                            " = ?"
                         ),
                         React.createElement("div", { className: "relative p-4 bg-slate-700 rounded-xl shadow-inner border border-slate-600" },
                             React.createElement("div", { 
                                 className: "grid gap-1 bg-slate-800 p-2 border-2 border-slate-500",
                                 style: { 
                                     gridTemplateColumns: `repeat(${currentProblem.den1}, 1fr)`,
                                     width: '300px',
                                     height: `${(300/currentProblem.den1) * currentProblem.den2}px` 
                                 } 
                             },
                                 decoratorGrid.map((active, i) => {
                                     const col = i % currentProblem.den1;
                                     const row = Math.floor(i / currentProblem.den1);
                                     
                                     // Visual Guides for "Fraction of a Fraction"
                                     const isRowGuide = row < currentProblem.num2;
                                     const isColGuide = col < currentProblem.num1;
                                     
                                     return React.createElement("button", { 
                                        key: i,
                                        onClick: () => handleDecoratorClick(i),
                                        className: `relative border border-slate-600 transition-all hover:bg-white/10 ${active ? 'bg-purple-500' : 'bg-transparent'}`
                                     },
                                        // Subtle guides to help student see the "rows" and "cols"
                                        !active && isColGuide && React.createElement("div", { className: "absolute inset-0 bg-blue-500/10 pointer-events-none" }),
                                        !active && isRowGuide && React.createElement("div", { className: "absolute inset-0 bg-red-500/10 pointer-events-none" })
                                     )
                                 })
                             )
                         ),
                         React.createElement("p", { className: "mt-4 text-slate-400 font-medium animate-pulse" }, "Paint the overlapping area!")
                     );
             }
          };

          // RENDER LOGIC
          let content = null;
          
          if (mode === 'menu') {
            const today = new Date().toDateString();
            const isDailyDone = dailyChallenge.lastCompleted === today;
            
            content = React.createElement("div", { className: `min-h-screen ${currentBg.class} flex flex-col font-sans relative overflow-hidden text-slate-100` },
              React.createElement(SvgPatterns),
              React.createElement(Snowfall), // Add Snowfall here
              renderConfetti(),
              
              // PET COMPONENT
              React.createElement(PetCompanion, {
                  level: petLevel,
                  onFeed: handleFeedPet,
                  canAffordFeed: coins >= 50,
                  coins: coins,
                  isHappy: isPetHappy,
                  isEating: isPetEating
              }),

              // Audio element removed from here to persist across modes
              React.createElement("header", { className: "bg-slate-800 border-b border-slate-700 p-4 flex justify-between items-center shadow-lg z-10" },
                 React.createElement("div", { className: "flex items-center gap-4" },
                    // AVATAR DISPLAY
                    React.createElement("div", { className: `relative p-2 rounded-xl border border-slate-600 ${currentApron.color}` }, 
                        React.createElement(currentHat.Icon, { className: currentHat.color || 'text-yellow-400', size: 24, stroke: "black", strokeWidth: 1.5 })
                    ),
                    React.createElement("div", null,
                        React.createElement("div", { className: "text-xs font-bold text-slate-400 uppercase tracking-wider" }, currentRank.title),
                        React.createElement("div", { className: "w-32 h-2 bg-slate-700 rounded-full mt-1 overflow-hidden" },
                           React.createElement("div", { className: "h-full bg-gradient-to-r from-green-400 to-emerald-500", style: { width: `${xpPercentage}%` } })
                        )
                    )
                 ),
                 React.createElement("div", { className: "flex gap-2" },
                    React.createElement("div", { className: "bg-slate-800 rounded-xl flex items-center border border-slate-600 overflow-hidden" },
                        React.createElement("button", { onClick: toggleMusic, className: `p-2 px-3 transition-all flex items-center gap-2 ${musicEnabled ? 'bg-green-600 text-white' : 'bg-slate-700 text-slate-400'}` },
                            musicEnabled ? React.createElement(Volume2, { size: 18 }) : React.createElement(VolumeX, { size: 18 }),
                            musicEnabled && React.createElement("span", { className: "text-xs font-bold" }, "ON")
                        ),
                        musicEnabled && React.createElement("button", { onClick: nextTrack, className: "p-2 hover:bg-slate-600 border-l border-slate-600 text-slate-300" }, React.createElement(SkipForward, { size: 16 }))
                    ),
                    React.createElement("button", { onClick: () => setShowSettings(!showSettings), className: `p-3 rounded-xl border transition-all ${showSettings ? 'bg-slate-700 border-slate-500 text-white' : 'bg-slate-800 border-slate-600 text-slate-400 hover:text-white'}` },
                        React.createElement(Settings, { size: 20 })
                    ),
                    React.createElement("button", { onClick: () => setMode('shop'), className: "flex items-center gap-3 bg-indigo-600 hover:bg-indigo-500 px-5 py-2 rounded-xl font-bold transition-all transform hover:scale-105 shadow-lg ring-1 ring-indigo-400" },
                        React.createElement(ShoppingBag, { size: 18 }), " Shop ", React.createElement("span", { className: "bg-indigo-800 px-2 py-0.5 rounded text-sm text-indigo-100" }, coins)
                    )
                 )
              ),
              
              // Decoration Shelf
              React.createElement("div", { className: "w-full max-w-4xl mx-auto mt-8 px-4" },
                  React.createElement("div", { className: "relative bg-[#5D4037] border-b-8 border-[#3E2723] rounded-lg shadow-xl p-4 min-h-[100px] flex items-end justify-center gap-6" },
                      // Shelf Shadow
                      React.createElement("div", { className: "absolute top-0 left-0 w-full h-4 bg-black/20 pointer-events-none" }),
                      decorations.length === 0 ? 
                          React.createElement("div", { className: "text-white/30 text-sm font-bold pb-2" }, "Your Trophy Shelf is Empty") :
                          decorations.map((decId, i) => {
                              const item = DECORATIONS[decId];
                              return React.createElement("div", { key: i, className: "animate-in slide-in-from-top-4 duration-700 transform hover:-translate-y-2 transition-transform cursor-help group relative" },
                                  React.cloneElement(item.icon, { size: 40, className: `drop-shadow-lg ${item.icon.props.className}` }),
                                  React.createElement("div", { className: "absolute bottom-full left-1/2 -translate-x-1/2 mb-2 bg-black/80 text-white text-xs px-2 py-1 rounded opacity-0 group-hover:opacity-100 whitespace-nowrap pointer-events-none" }, item.name)
                              );
                          })
                  )
              ),

              // Daily Challenge Banner
              React.createElement("div", { className: "w-full max-w-6xl mx-auto mt-6 px-8" },
                  React.createElement("button", { 
                      onClick: isDailyDone ? null : startDailyChallenge,
                      disabled: isDailyDone,
                      className: `w-full p-4 rounded-2xl flex items-center justify-between border-2 transition-all ${isDailyDone ? 'bg-slate-800 border-slate-600 opacity-50 cursor-default' : 'bg-gradient-to-r from-orange-500 to-red-600 border-orange-400 shadow-xl hover:scale-[1.01]'}` 
                  },
                      React.createElement("div", { className: "flex items-center gap-4" },
                          React.createElement("div", { className: "bg-white/20 p-3 rounded-full" }, React.createElement(Calendar, { className: "text-white", size: 24 })),
                          React.createElement("div", { className: "text-left" },
                              React.createElement("h3", { className: "text-xl font-black text-white" }, "DAILY SPECIAL"),
                              React.createElement("p", { className: "text-orange-100 font-medium" }, isDailyDone ? "Come back tomorrow!" : "Complete for 50 Bonus Coins")
                          )
                      ),
                      isDailyDone && React.createElement(CheckCircle, { className: "text-green-400", size: 32 })
                  )
              ),
              // Settings Modal/Dropdown
              showSettings && React.createElement("div", { className: "absolute top-20 right-4 z-50 w-64 bg-slate-800 border border-slate-600 rounded-2xl shadow-2xl p-4 animate-in slide-in-from-top-2" },
                 React.createElement("h3", { className: "text-slate-400 text-xs font-bold uppercase tracking-widest mb-3" }, "Data Management"),
                 React.createElement("div", { className: "flex flex-col gap-2" },
                    React.createElement("button", { onClick: handleSaveGame, className: "flex items-center gap-3 w-full p-3 rounded-xl bg-slate-700 hover:bg-slate-600 transition-colors text-left font-bold" },
                        React.createElement(Download, { size: 18, className: "text-blue-400" }), "Save Game"
                    ),
                    React.createElement("label", { className: "flex items-center gap-3 w-full p-3 rounded-xl bg-slate-700 hover:bg-slate-600 transition-colors text-left font-bold cursor-pointer" },
                        React.createElement(Upload, { size: 18, className: "text-green-400" }), "Load Game",
                        React.createElement("input", { type: "file", accept: ".json", onChange: handleLoadGame, className: "hidden", ref: fileInputRef })
                    )
                 )
              ),
              React.createElement("div", { className: "flex-grow flex flex-col items-center p-8 max-w-6xl mx-auto w-full" },
                 React.createElement("div", { className: "text-center mb-12" },
                    React.createElement("h1", { className: "text-6xl font-black text-transparent bg-clip-text bg-gradient-to-r from-yellow-400 via-orange-500 to-red-500 mb-4 drop-shadow-sm tracking-tight" }, "BAKERY BOSS"),
                    React.createElement("p", { className: "text-slate-400 text-lg font-medium" }, "Master the art of fractions.")
                 ),
                 React.createElement("div", { className: "grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 w-full" },
                    Object.keys(STATION_COSTS).map(stationId => {
                        const isUnlocked = unlockedStations.includes(stationId);
                        const cost = STATION_COSTS[stationId];
                        const canAfford = coins >= cost;
                        
                        // Mapping station ID to display data
                        const stationData = {
                            'frac-mult-frac': { title: "Prep Station", desc: "Multiplication Models", icon: React.createElement(Grid, {size:32,className:"text-white"}), color: "from-blue-600 to-blue-800" },
                            'snack-sharing': { title: "Catering", desc: "Snack Sharing", icon: React.createElement(Cookie, {size:32,className:"text-white"}), color: "from-yellow-600 to-amber-800" },
                            'cake-decorator': { title: "Design Station", desc: "Cake Decorating", icon: React.createElement(Brush, {size:32,className:"text-white"}), color: "from-pink-600 to-rose-800" },
                            'whole-div-unit': { title: "The Ovens", desc: "Division Slicing", icon: React.createElement(PieChart, {size:32,className:"text-white"}), color: "from-orange-600 to-red-800" },
                            'word-match': { title: "Order Counter", desc: "Word Problems", icon: React.createElement(BookOpen, {size:32,className:"text-white"}), color: "from-purple-600 to-indigo-800" },
                            'comparison': { title: "Quality Control", desc: "Estimation & Logic", icon: React.createElement(Scale, {size:32,className:"text-white"}), color: "from-emerald-600 to-teal-800" }
                        }[stationId];

                        return React.createElement(StationCard, { 
                            key: stationId,
                            title: stationData.title, 
                            desc: stationData.desc, 
                            icon: stationData.icon, 
                            color: stationData.color, 
                            onClick: () => handleStartGame(stationId),
                            locked: !isUnlocked,
                            cost: cost,
                            canAfford: canAfford,
                            onUnlock: () => handleUnlockStation(stationId)
                        });
                    })
                 )
              )
            );
          }

          if (mode === 'shop') {
              const preview = THEMES[previewTheme];
              const powerUps = STICKERS.filter(s => s.effect);
              const badges = STICKERS.filter(s => !s.effect);
              content = React.createElement("div", { className: `min-h-screen ${currentBg.class} flex flex-col font-sans text-slate-100 relative overflow-hidden` },
                 React.createElement(SvgPatterns),
                 React.createElement(Snowfall), // Add Snowfall here
                 renderConfetti(),
                 
                 // RECIPE MODAL
                 selectedRecipe && React.createElement("div", { className: "fixed inset-0 z-50 flex items-center justify-center bg-black/80 backdrop-blur-sm animate-in zoom-in p-4" },
                    React.createElement("div", { className: "bg-white text-slate-900 w-full max-w-lg rounded-3xl p-8 relative shadow-2xl overflow-y-auto max-h-[90vh]" },
                        React.createElement("button", { 
                            onClick: () => setSelectedRecipe(null), 
                            className: "absolute top-4 right-4 bg-slate-200 hover:bg-slate-300 p-2 rounded-full transition-colors"
                        }, "✕"),
                        
                        React.createElement("div", { className: "flex items-center gap-4 mb-6" },
                            React.createElement("div", { className: "bg-orange-100 p-4 rounded-2xl" }, 
                                React.cloneElement(selectedRecipe.icon, { size: 48 })
                            ),
                            React.createElement("div", null,
                                React.createElement("div", { className: "text-orange-600 font-bold uppercase tracking-widest text-xs" }, "Secret Recipe"),
                                React.createElement("h2", { className: "text-3xl font-black" }, selectedRecipe.name)
                            )
                        ),
                        
                        React.createElement("div", { className: "bg-slate-50 p-4 rounded-xl mb-6 border border-slate-200" },
                            React.createElement("h3", { className: "font-bold text-slate-700 mb-2 flex items-center gap-2" }, React.createElement(ShoppingBag, {size:18}), " Ingredients"),
                            React.createElement("ul", { className: "list-disc list-inside space-y-1 text-slate-600" },
                                selectedRecipe.ingredients.map((ing, i) => React.createElement("li", { key: i }, ing))
                            )
                        ),
                        
                        React.createElement("div", null,
                            React.createElement("h3", { className: "font-bold text-slate-700 mb-2 flex items-center gap-2" }, React.createElement(UtensilsCrossed, {size:18}), " Instructions"),
                            React.createElement("ol", { className: "space-y-3 text-slate-600" },
                                selectedRecipe.steps.map((step, i) => React.createElement("li", { key: i, className: "bg-slate-50 p-3 rounded-lg border border-slate-100" }, step))
                            )
                        )
                    )
                 ),

                 React.createElement("div", { className: "bg-slate-800 border-b border-slate-700 p-4 flex justify-between items-center z-10" },
                    React.createElement("button", { onClick: () => setMode('menu'), className: "font-bold text-slate-400 hover:text-white flex items-center gap-2" }, "← Back"),
                    React.createElement("div", { className: "flex items-center gap-2 text-yellow-400 font-black text-xl" }, React.createElement("span",null,coins), React.createElement("span",{className:"text-yellow-600"},"G"))
                 ),
                 // TABS
                 React.createElement("div", { className: "flex justify-center gap-4 mt-6 flex-wrap px-4" },
                     React.createElement("button", { 
                         onClick: () => setShopTab('bakery'), 
                         className: `px-6 py-2 rounded-full font-bold transition-all ${shopTab === 'bakery' ? 'bg-indigo-600 text-white shadow-lg scale-105' : 'bg-slate-700 text-slate-400 hover:bg-slate-600'}` 
                     }, "Bakery Upgrades"),
                     React.createElement("button", { 
                         onClick: () => setShopTab('chef'), 
                         className: `px-6 py-2 rounded-full font-bold transition-all ${shopTab === 'chef' ? 'bg-orange-600 text-white shadow-lg scale-105' : 'bg-slate-700 text-slate-400 hover:bg-slate-600'}` 
                     }, "Chef Gear"),
                     React.createElement("button", { 
                         onClick: () => setShopTab('renovate'), 
                         className: `px-6 py-2 rounded-full font-bold transition-all ${shopTab === 'renovate' ? 'bg-pink-600 text-white shadow-lg scale-105' : 'bg-slate-700 text-slate-400 hover:bg-slate-600'}` 
                     }, "Renovate"),
                     React.createElement("button", { 
                         onClick: () => setShopTab('cookbook'), 
                         className: `px-6 py-2 rounded-full font-bold transition-all ${shopTab === 'cookbook' ? 'bg-amber-600 text-white shadow-lg scale-105' : 'bg-slate-700 text-slate-400 hover:bg-slate-600'}` 
                     }, "Cookbook"),
                     React.createElement("button", { 
                         onClick: () => setShopTab('pet'), 
                         className: `px-6 py-2 rounded-full font-bold transition-all ${shopTab === 'pet' ? 'bg-green-600 text-white shadow-lg scale-105' : 'bg-slate-700 text-slate-400 hover:bg-slate-600'}` 
                     }, "Pet Care")
                 ),
                 
                 React.createElement("div", { className: "flex-grow p-8 max-w-6xl mx-auto w-full grid grid-cols-1 lg:grid-cols-3 gap-8 overflow-y-auto" },
                     
                     // --- BAKERY TAB ---
                     shopTab === 'bakery' && React.createElement(React.Fragment, null,
                         React.createElement("div", { className: "lg:col-span-1 flex flex-col gap-6" },
                            React.createElement("div", { className: "bg-slate-800 rounded-3xl p-6 border border-slate-700 shadow-2xl relative overflow-hidden" },
                               React.createElement("div", { className: "absolute top-0 right-0 p-4 opacity-10" }, React.createElement(Palette,{size:100})),
                               React.createElement("h2", { className: "text-3xl font-black mb-2" }, preview.name),
                           React.createElement("div", { className: "mb-6 flex gap-2" }, 
                               React.createElement("span", { className: `px-2 py-1 rounded text-xs font-bold uppercase ${preview.rarity === 'mythic' ? 'bg-red-950 text-red-500 border border-red-500' : preview.rarity === 'legendary' ? 'bg-yellow-500 text-black' : preview.rarity === 'epic' ? 'bg-purple-500 text-white' : 'bg-slate-600 text-slate-300'}` }, preview.rarity),
                               inventory.includes(preview.id) && React.createElement("span", { className: "px-2 py-1 rounded text-xs font-bold bg-green-500 text-black uppercase" }, "Owned")
                           ),
                           React.createElement("div", { className: "flex flex-col gap-8 items-center py-8 bg-slate-900/50 rounded-2xl" },
                               React.createElement(Render3DCake, { type: "round", pieces: 1, themeId: preview.id }),
                                   React.createElement(Render3DCake, { type: "rect", pieces: 1, themeId: preview.id })
                               ),
                               React.createElement("div", { className: "mt-6" },
                                   inventory.includes(preview.id) ? 
                                       React.createElement("button", { onClick: () => { handleEquipTheme(preview.id); }, className: `w-full py-4 rounded-xl font-bold text-lg shadow-lg transition-all ${equippedTheme === preview.id ? 'bg-green-600 text-white cursor-default' : 'bg-white text-slate-900 hover:bg-slate-200'}` }, equippedTheme === preview.id ? 'EQUIPPED' : 'EQUIP')
                                   :
                                       React.createElement("div", { className: "w-full py-4 rounded-xl font-bold text-lg bg-slate-700 text-slate-500 text-center flex items-center justify-center gap-2" }, React.createElement(Lock,{size:18}), " Unlock in Crates")
                               )
                            )
                         ),
                         React.createElement("div", { className: "lg:col-span-2 flex flex-col gap-8" },
                            React.createElement("div", { className: "bg-gradient-to-r from-indigo-900 to-purple-900 rounded-3xl p-8 border border-indigo-700 shadow-xl relative overflow-hidden" },
                               React.createElement("div", { className: "relative z-10 flex items-center justify-between" },
                                   React.createElement("div", null,
                                       React.createElement("h3", { className: "text-2xl font-black text-white mb-1" }, "Mystery Box"),
                                       React.createElement("p", { className: "text-indigo-200" }, "Contains randomized skins, stickers, & recipes.")
                                   ),
                                   React.createElement("button", { onClick: buyCrate, disabled: coins < 200 || isOpeningCrate, className: "bg-yellow-400 hover:bg-yellow-300 text-yellow-900 px-8 py-4 rounded-xl font-black text-lg shadow-lg transform active:scale-95 transition-all disabled:opacity-50 disabled:transform-none" }, isOpeningCrate ? 'Opening...' : 'Open (200 G)')
                               )
                            ),
                            crateReward && React.createElement("div", { className: "fixed inset-0 z-50 flex items-center justify-center bg-black/80 backdrop-blur-sm animate-in fade-in" },
                               React.createElement("div", { className: "bg-slate-900 border-2 border-yellow-500 p-10 rounded-3xl text-center max-w-sm w-full shadow-2xl transform scale-110" },
                                   React.createElement("div", { className: "text-6xl mb-6 animate-bounce" },
                                      crateReward.type === 'theme' ? React.createElement(Palette,{size:80,className:"mx-auto text-yellow-400"}) : 
                                      crateReward.type === 'recipe' ? React.createElement(Book,{size:80,className:"mx-auto text-yellow-400"}) :
                                      (crateReward.Icon ? React.createElement(crateReward.Icon,{size:80,className:"mx-auto text-yellow-400"}) : crateReward.icon)
                                   ),
                                   React.createElement("h3", { className: "text-2xl font-bold text-yellow-500 uppercase tracking-widest mb-2" }, "Unlocked!"),
                                   React.createElement("div", { className: "text-4xl font-black text-white mb-2" }, crateReward.name),
                                   crateReward.type === 'recipe' && React.createElement("div", { className: "text-lg text-slate-300 mb-6 italic" }, "Added to Cookbook"),
                                   React.createElement("button", { onClick: () => setCrateReward(null), className: "w-full bg-white text-black font-bold py-4 rounded-xl hover:bg-slate-200" }, "Collect")
                               )
                            ),
                            React.createElement("div", { className: "bg-slate-800 rounded-3xl p-6 border border-slate-700" },
                               React.createElement("h3", { className: "text-lg font-bold text-slate-400 uppercase tracking-widest mb-4" }, "Your Flavors"),
                               React.createElement("div", { className: "grid grid-cols-4 sm:grid-cols-5 md:grid-cols-6 gap-3" },
                                   Object.values(THEMES).map(t => {
                                       const owned = inventory.includes(t.id);
                                       return React.createElement("button", { key: t.id, onClick: () => setPreviewTheme(t.id), className: `aspect-square rounded-xl border-2 relative overflow-hidden transition-all ${previewTheme === t.id ? 'border-yellow-400 ring-2 ring-yellow-400/50 scale-105 z-10' : 'border-slate-600 hover:border-slate-400'} ${!owned && 'opacity-40 grayscale'}` },
                                           React.createElement("svg", { width: "100%", height: "100%" }, React.createElement("rect", { width: "100%", height: "100%", fill: t.fill })),
                                           !owned && React.createElement("div", { className: "absolute inset-0 flex items-center justify-center bg-black/50" }, React.createElement(Lock,{size:16,className:"text-white"}))
                                       )
                                   })
                               )
                            ),
                            React.createElement("div", { className: "bg-slate-800 rounded-3xl p-6 border border-slate-700" },
                               React.createElement("h3", { className: "text-lg font-bold text-yellow-400 uppercase tracking-widest mb-4 flex items-center gap-2" }, React.createElement(Zap,{size:18}), " Kitchen Power-Ups (Equip 1)"),
                               React.createElement("div", { className: "grid grid-cols-4 sm:grid-cols-5 md:grid-cols-6 gap-3" },
                                  powerUps.map(s => {
                                    const owned = stickers.includes(s.id);
                                    const equipped = equippedSticker === s.id;
                                    return React.createElement("button", { key: s.id, disabled: !owned, onClick: () => { if(owned) handleEquipSticker(s.id) }, className: `group aspect-square rounded-xl border-2 flex flex-col items-center justify-center gap-1 relative transition-all ${equipped ? 'border-green-500 ring-2 ring-green-500/50 bg-slate-700' : 'border-slate-600 bg-slate-800 hover:border-indigo-400'} ${!owned && 'opacity-50 grayscale'}` },
                                        React.createElement(s.Icon, { size: 24, className: owned ? (equipped ? 'text-green-400' : 'text-yellow-200') : 'text-slate-500' }),
                                        equipped && React.createElement("div", { className: "absolute top-1 right-1 text-green-500" }, React.createElement(CheckCircle,{size:12})),
                                        React.createElement("div", { className: "absolute -top-12 left-1/2 -translate-x-1/2 w-32 bg-black/90 text-white text-[10px] p-2 rounded-lg pointer-events-none opacity-0 group-hover:opacity-100 transition-opacity z-20 shadow-xl border border-slate-600" },
                                            React.createElement("div", { className: "font-bold text-yellow-400 mb-1" }, s.name),
                                            React.createElement("div", { className: "leading-tight" }, s.funDesc),
                                            React.createElement("div", { className: "absolute bottom-[-6px] left-1/2 -translate-x-1/2 w-0 h-0 border-l-[6px] border-l-transparent border-r-[6px] border-r-transparent border-t-[6px] border-t-black/90" })
                                        )
                                    )
                                  })
                               )
                            ),
                            React.createElement("div", { className: "bg-slate-800 rounded-3xl p-6 border border-slate-700" },
                               React.createElement("h3", { className: "text-lg font-bold text-slate-400 uppercase tracking-widest mb-4 flex items-center gap-2" }, React.createElement(Trophy,{size:18}), " Badge Collection"),
                               React.createElement("div", { className: "grid grid-cols-4 sm:grid-cols-6 md:grid-cols-8 gap-3" },
                                  badges.map(s => {
                                    const owned = stickers.includes(s.id);
                                    return React.createElement("div", { key: s.id, className: `group aspect-square rounded-xl border-2 flex flex-col items-center justify-center gap-1 relative bg-slate-700/50 transition-all ${owned ? 'border-slate-500 bg-slate-700' : 'border-slate-700 opacity-40 grayscale'}` },
                                        React.createElement(s.Icon, { size: 20, className: owned ? (s.color || 'text-slate-300') : 'text-slate-600' }),
                                        React.createElement("div", { className: "absolute -top-16 left-1/2 -translate-x-1/2 w-32 bg-black/90 text-white text-[10px] p-2 rounded-lg pointer-events-none opacity-0 group-hover:opacity-100 transition-opacity z-20 shadow-xl border border-slate-600" },
                                            React.createElement("div", { className: "font-bold text-yellow-400 mb-1" }, s.name),
                                            React.createElement("div", { className: "leading-tight text-slate-300 mb-1" }, owned ? s.desc : (s.hint || "Keep playing to unlock!")),
                                            !owned && React.createElement("div", { className: "text-[9px] text-red-400 font-bold uppercase" }, "LOCKED"),
                                            React.createElement("div", { className: "absolute bottom-[-6px] left-1/2 -translate-x-1/2 w-0 h-0 border-l-[6px] border-l-transparent border-r-[6px] border-r-transparent border-t-[6px] border-t-black/90" })
                                        )
                                    )
                                  })
                               )
                            )
                         )
                     ),

                     // --- CHEF GEAR TAB ---
                     shopTab === 'chef' && React.createElement("div", { className: "lg:col-span-3 grid grid-cols-1 md:grid-cols-3 gap-8" },
                         // HATS
                         React.createElement("div", { className: "bg-slate-800 rounded-3xl p-6 border border-slate-700 h-fit" },
                             React.createElement("h3", { className: "text-lg font-bold text-slate-400 uppercase tracking-widest mb-4 flex items-center gap-2" }, React.createElement(ChefHat,{size:20}), " Headwear"),
                             React.createElement("div", { className: "flex flex-col gap-3" },
                                 Object.values(HATS).map(item => {
                                     const owned = hats.includes(item.id);
                                     const equipped = equippedHat === item.id;
                                     return React.createElement("button", { 
                                         key: item.id, 
                                         onClick: () => handleBuyHat(item.id),
                                         className: `flex items-center justify-between p-3 rounded-xl border-2 transition-all ${equipped ? 'bg-slate-700 border-green-500' : 'bg-slate-900 border-slate-700 hover:border-slate-500'}`
                                     },
                                         React.createElement("div", { className: "flex items-center gap-3" },
                                             React.createElement("div", { className: "bg-slate-800 p-2 rounded-lg" }, React.createElement(item.Icon, { className: item.color || 'text-white', stroke: "black", strokeWidth: 1.5 })),
                                             React.createElement("div", { className: "text-left" },
                                                 React.createElement("div", { className: "font-bold text-sm" }, item.name),
                                                 !owned && React.createElement("div", { className: "text-xs text-yellow-400" }, item.cost + " G")
                                             )
                                         ),
                                         owned ? (equipped ? React.createElement(CheckCircle, { size: 20, className: "text-green-500" }) : null) : React.createElement(Lock, { size: 16, className: "text-slate-600" })
                                     );
                                 })
                             )
                         ),
                         // TOOLS
                         React.createElement("div", { className: "bg-slate-800 rounded-3xl p-6 border border-slate-700 h-fit" },
                             React.createElement("h3", { className: "text-lg font-bold text-slate-400 uppercase tracking-widest mb-4 flex items-center gap-2" }, React.createElement(Hammer,{size:20}), " Tools (Cursor)"),
                             React.createElement("div", { className: "flex flex-col gap-3" },
                                 Object.values(TOOLS).map(item => {
                                     const owned = tools.includes(item.id);
                                     const equipped = equippedTool === item.id;
                                     return React.createElement("button", { 
                                         key: item.id, 
                                         onClick: () => handleBuyTool(item.id),
                                         className: `flex items-center justify-between p-3 rounded-xl border-2 transition-all ${equipped ? 'bg-slate-700 border-green-500' : 'bg-slate-900 border-slate-700 hover:border-slate-500'}`
                                     },
                                         React.createElement("div", { className: "flex items-center gap-3" },
                                             React.createElement("div", { className: "bg-slate-800 p-2 rounded-lg w-10 h-10 flex items-center justify-center" }, 
                                                item.id === 'default' ? React.createElement(Grid, {size:20}) :
                                                React.createElement("div", { 
                                                    style: { 
                                                        width: 24, height: 24, 
                                                        background: item.icon.split(' ')[0].replace('url(','').replace(')',''),
                                                        backgroundSize: 'contain',
                                                        backgroundRepeat: 'no-repeat'
                                                    } 
                                                })
                                             ),
                                             React.createElement("div", { className: "text-left" },
                                                 React.createElement("div", { className: "font-bold text-sm" }, item.name),
                                                 !owned && React.createElement("div", { className: "text-xs text-yellow-400" }, item.cost + " G")
                                             )
                                         ),
                                         owned ? (equipped ? React.createElement(CheckCircle, { size: 20, className: "text-green-500" }) : null) : React.createElement(Lock, { size: 16, className: "text-slate-600" })
                                     );
                                 })
                             )
                         ),
                         // APRONS
                         React.createElement("div", { className: "bg-slate-800 rounded-3xl p-6 border border-slate-700 h-fit" },
                             React.createElement("h3", { className: "text-lg font-bold text-slate-400 uppercase tracking-widest mb-4 flex items-center gap-2" }, React.createElement(Shirt,{size:20}), " Aprons"),
                             React.createElement("div", { className: "flex flex-col gap-3" },
                                 Object.values(APRONS).map(item => {
                                     const owned = aprons.includes(item.id);
                                     const equipped = equippedApron === item.id;
                                     return React.createElement("button", { 
                                         key: item.id, 
                                         onClick: () => handleBuyApron(item.id),
                                         className: `flex items-center justify-between p-3 rounded-xl border-2 transition-all ${equipped ? 'bg-slate-700 border-green-500' : 'bg-slate-900 border-slate-700 hover:border-slate-500'}`
                                     },
                                         React.createElement("div", { className: "flex items-center gap-3" },
                                             React.createElement("div", { className: `p-2 rounded-lg ${item.color} w-10 h-10 flex items-center justify-center` }, React.createElement(User, { size: 20 })),
                                             React.createElement("div", { className: "text-left" },
                                                 React.createElement("div", { className: "font-bold text-sm" }, item.name),
                                                 !owned && React.createElement("div", { className: "text-xs text-yellow-400" }, item.cost + " G")
                                             )
                                         ),
                                         owned ? (equipped ? React.createElement(CheckCircle, { size: 20, className: "text-green-500" }) : null) : React.createElement(Lock, { size: 16, className: "text-slate-600" })
                                     );
                                 })
                             )
                         )
                     ),

                     // --- RENOVATIONS TAB ---
                     shopTab === 'renovate' && React.createElement("div", { className: "lg:col-span-3 grid grid-cols-1 md:grid-cols-3 gap-8" },
                         // BACKGROUNDS
                         React.createElement("div", { className: "bg-slate-800 rounded-3xl p-6 border border-slate-700 h-fit" },
                             React.createElement("h3", { className: "text-lg font-bold text-slate-400 uppercase tracking-widest mb-4 flex items-center gap-2" }, React.createElement(Layout,{size:20}), " Backgrounds"),
                             React.createElement("div", { className: "flex flex-col gap-3" },
                                 Object.values(BACKGROUNDS).map(item => {
                                     const owned = backgrounds.includes(item.id);
                                     const equipped = equippedBackground === item.id;
                                     return React.createElement("button", { 
                                         key: item.id, 
                                         onClick: () => handleBuyBackground(item.id),
                                         className: `flex items-center justify-between p-3 rounded-xl border-2 transition-all ${equipped ? 'bg-slate-700 border-green-500' : 'bg-slate-900 border-slate-700 hover:border-slate-500'}`
                                     },
                                         React.createElement("div", { className: "flex items-center gap-3" },
                                             React.createElement("div", { className: `p-2 rounded-lg w-10 h-10 border border-slate-600 ${item.class}` }),
                                             React.createElement("div", { className: "text-left" },
                                                 React.createElement("div", { className: "font-bold text-sm" }, item.name),
                                                 !owned && React.createElement("div", { className: "text-xs text-yellow-400" }, item.cost + " G")
                                             )
                                         ),
                                         owned ? (equipped ? React.createElement(CheckCircle, { size: 20, className: "text-green-500" }) : null) : React.createElement(Lock, { size: 16, className: "text-slate-600" })
                                     );
                                 })
                             )
                         ),
                         // COUNTERTOPS
                         React.createElement("div", { className: "bg-slate-800 rounded-3xl p-6 border border-slate-700 h-fit" },
                             React.createElement("h3", { className: "text-lg font-bold text-slate-400 uppercase tracking-widest mb-4 flex items-center gap-2" }, React.createElement(Box,{size:20}), " Counters"),
                             React.createElement("div", { className: "flex flex-col gap-3" },
                                 Object.values(COUNTERTOPS).map(item => {
                                     const owned = countertops.includes(item.id);
                                     const equipped = equippedCountertop === item.id;
                                     return React.createElement("button", { 
                                         key: item.id, 
                                         onClick: () => handleBuyCountertop(item.id),
                                         className: `flex items-center justify-between p-3 rounded-xl border-2 transition-all ${equipped ? 'bg-slate-700 border-green-500' : 'bg-slate-900 border-slate-700 hover:border-slate-500'}`
                                     },
                                         React.createElement("div", { className: "flex items-center gap-3" },
                                             React.createElement("div", { className: `p-2 rounded-lg w-10 h-10 border border-slate-600 ${item.class}` }),
                                             React.createElement("div", { className: "text-left" },
                                                 React.createElement("div", { className: "font-bold text-sm" }, item.name),
                                                 !owned && React.createElement("div", { className: "text-xs text-yellow-400" }, item.cost + " G")
                                             )
                                         ),
                                         owned ? (equipped ? React.createElement(CheckCircle, { size: 20, className: "text-green-500" }) : null) : React.createElement(Lock, { size: 16, className: "text-slate-600" })
                                     );
                                 })
                             )
                         ),
                         // DECORATIONS (SHELF)
                         React.createElement("div", { className: "bg-slate-800 rounded-3xl p-6 border border-slate-700 h-fit" },
                             React.createElement("h3", { className: "text-lg font-bold text-slate-400 uppercase tracking-widest mb-4 flex items-center gap-2" }, React.createElement(Trophy,{size:20}), " Shelf Decor"),
                             React.createElement("div", { className: "flex flex-col gap-3" },
                                 Object.values(DECORATIONS).map(item => {
                                     const owned = decorations.includes(item.id);
                                     return React.createElement("button", { 
                                         key: item.id, 
                                         onClick: () => handleBuyDecoration(item.id),
                                         disabled: owned,
                                         className: `flex items-center justify-between p-3 rounded-xl border-2 transition-all ${owned ? 'bg-slate-800 border-slate-700 opacity-50 cursor-default' : 'bg-slate-900 border-slate-700 hover:border-slate-500'}`
                                     },
                                         React.createElement("div", { className: "flex items-center gap-3" },
                                             React.createElement("div", { className: "bg-slate-800 p-2 rounded-lg w-10 h-10 flex items-center justify-center" }, 
                                                 React.cloneElement(item.icon, { size: 20 })
                                             ),
                                             React.createElement("div", { className: "text-left" },
                                                 React.createElement("div", { className: "font-bold text-sm" }, item.name),
                                                 !owned ? React.createElement("div", { className: "text-xs text-yellow-400" }, item.cost + " G") : React.createElement("div", { className: "text-xs text-green-500" }, "Owned")
                                             )
                                         ),
                                         owned && React.createElement(CheckCircle, { size: 20, className: "text-green-500" })
                                     );
                                 })
                             )
                         )
                     ),

                     // --- COOKBOOK TAB ---
                     shopTab === 'cookbook' && React.createElement("div", { className: "lg:col-span-3" },
                         React.createElement("div", { className: "bg-slate-800 rounded-3xl p-6 border border-slate-700" },
                             React.createElement("div", { className: "flex items-center justify-between mb-6" },
                                React.createElement("h3", { className: "text-2xl font-black text-slate-100 flex items-center gap-3" }, 
                                    React.createElement(Book, { className: "text-amber-500", size: 32 }), 
                                    "Secret Recipes"
                                ),
                                React.createElement("div", { className: "text-slate-400 font-bold" }, 
                                    `${unlockedRecipes.length}/${Object.keys(RECIPES).length} Found`
                                )
                             ),
                             React.createElement("div", { className: "grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6" },
                                 Object.values(RECIPES).map(recipe => {
                                     const isUnlocked = unlockedRecipes.includes(recipe.id);
                                     return React.createElement("button", { 
                                         key: recipe.id, 
                                         onClick: isUnlocked ? () => setSelectedRecipe(recipe) : null,
                                         disabled: !isUnlocked,
                                         className: `relative h-48 rounded-2xl p-6 text-left border-2 transition-all group overflow-hidden ${isUnlocked ? 'bg-amber-50 border-amber-200 hover:border-amber-400 hover:shadow-xl hover:-translate-y-1' : 'bg-slate-900 border-slate-700 opacity-60 cursor-not-allowed'}`
                                     },
                                         // Background Pattern for Card
                                         isUnlocked && React.createElement("div", { className: "absolute top-0 right-0 p-8 opacity-10 transform rotate-12 group-hover:rotate-0 transition-transform duration-500" }, 
                                             React.cloneElement(recipe.icon, { size: 120, className: "text-amber-900" })
                                         ),
                                         
                                         React.createElement("div", { className: "relative z-10 h-full flex flex-col justify-between" },
                                             React.createElement("div", null,
                                                 React.createElement("div", { className: "flex justify-between items-start mb-2" },
                                                     React.createElement("div", { className: `p-3 rounded-xl ${isUnlocked ? 'bg-white shadow-md' : 'bg-slate-800'}` },
                                                         isUnlocked ? React.cloneElement(recipe.icon, { size: 24 }) : React.createElement(Lock, { size: 24, className: "text-slate-500" })
                                                     ),
                                                     isUnlocked && React.createElement("div", { className: "bg-amber-200 text-amber-900 text-[10px] font-bold px-2 py-1 rounded-full uppercase" }, "Secret")
                                                 ),
                                                 React.createElement("h4", { className: `text-xl font-black ${isUnlocked ? 'text-amber-900' : 'text-slate-500'}` }, isUnlocked ? recipe.name : "Unknown Recipe"),
                                                 React.createElement("p", { className: `text-sm mt-1 font-medium ${isUnlocked ? 'text-amber-700' : 'text-slate-600'}` }, isUnlocked ? recipe.desc : "Find in Mystery Boxes to unlock.")
                                             ),
                                             isUnlocked && React.createElement("div", { className: "text-amber-600 text-sm font-bold flex items-center gap-1 group-hover:gap-2 transition-all" }, 
                                                 "View Recipe", React.createElement(ArrowRight, { size: 16 })
                                             )
                                         )
                                     );
                                 })
                             )
                         )
                     ),

                     // --- PET CARE TAB ---
                     shopTab === 'pet' && React.createElement("div", { className: "lg:col-span-3 grid grid-cols-1 md:grid-cols-2 gap-8" },
                         
                         // PREVIEW WINDOW (Spans both cols on desktop)
                         React.createElement("div", { className: "md:col-span-2 bg-slate-800 rounded-3xl p-8 border border-slate-700 flex flex-col items-center justify-center relative overflow-hidden min-h-[350px]" },
                             // Spotlight Effect
                             React.createElement("div", { className: "absolute inset-0 opacity-10 pointer-events-none", style: { background: "radial-gradient(circle, #fbbf24 0%, transparent 60%)" } }),
                             
                             React.createElement("h3", { className: "text-slate-400 font-bold uppercase tracking-widest mb-2 z-10" }, "Pet Preview"),
                             
                             // The Pet Preview
                             React.createElement("div", { className: "transform scale-150 z-10 mb-8" },
                                  React.createElement(PetCompanion, {
                                      level: petLevel,
                                      skinId: previewPetSkin || equippedPetSkin,
                                      hatId: previewPetHat || equippedPetHat,
                                      onFeed: () => {}, // Disable feeding in preview
                                      canAffordFeed: false, 
                                      coins: coins,
                                      isHappy: isPetHappy,
                                      isEating: isPetEating,
                                      className: "relative flex flex-col items-center" 
                                  })
                             ),

                             // Action Bar (Only shows if an item is selected)
                             selectedPetItem ? (() => {
                                 const isSkin = selectedPetItem.type === 'skin';
                                 const item = isSkin ? PET_SKINS[selectedPetItem.id] : PET_HATS[selectedPetItem.id];
                                 const isOwned = isSkin ? petSkins.includes(item.id) : petHats.includes(item.id);
                                 const isEquipped = isSkin ? equippedPetSkin === item.id : equippedPetHat === item.id;
                                 const canAfford = coins >= item.cost;

                                 return React.createElement("div", { className: "z-10 w-full max-w-md bg-slate-900/80 backdrop-blur p-4 rounded-2xl border border-slate-600 flex items-center justify-between animate-in slide-in-from-bottom-2" },
                                     React.createElement("div", null,
                                         React.createElement("div", { className: "font-black text-xl text-white" }, item.name),
                                         React.createElement("div", { className: "text-slate-400 text-sm" }, isOwned ? "In Inventory" : `${item.cost} Gold`)
                                     ),
                                     React.createElement("button", { 
                                         onClick: () => isSkin ? handleBuyPetSkin(item.id) : handleBuyPetHat(item.id),
                                         disabled: !isOwned && !canAfford,
                                         className: `px-6 py-2 rounded-xl font-bold shadow-lg transition-all ${
                                             isEquipped ? 'bg-green-600 text-white cursor-default' :
                                             isOwned ? 'bg-blue-600 hover:bg-blue-500 text-white' :
                                             canAfford ? 'bg-yellow-500 hover:bg-yellow-400 text-black' :
                                             'bg-slate-700 text-slate-500 cursor-not-allowed'
                                         }`
                                     }, isEquipped ? "Equipped" : isOwned ? "Equip" : "Buy")
                                 );
                             })() : React.createElement("div", { className: "text-slate-500 italic z-10" }, "Select an item below to preview")
                         ),

                         // PET SKINS LIST
                         React.createElement("div", { className: "bg-slate-800 rounded-3xl p-6 border border-slate-700 h-fit" },
                             React.createElement("h3", { className: "text-lg font-bold text-slate-400 uppercase tracking-widest mb-4 flex items-center gap-2" }, React.createElement(Cookie,{size:20}), " Dough Flavors"),
                             React.createElement("div", { className: "flex flex-col gap-3" },
                                 Object.values(PET_SKINS).map(item => {
                                     const owned = petSkins.includes(item.id);
                                     const equipped = equippedPetSkin === item.id;
                                     const isSelected = selectedPetItem?.id === item.id && selectedPetItem?.type === 'skin';
                                     
                                     return React.createElement("button", { 
                                         key: item.id, 
                                         onClick: () => {
                                             setPreviewPetSkin(item.id);
                                             setSelectedPetItem({ type: 'skin', id: item.id });
                                         },
                                         className: `flex items-center justify-between p-3 rounded-xl border-2 transition-all ${isSelected ? 'bg-slate-700 border-yellow-400 ring-2 ring-yellow-400/30' : 'bg-slate-900 border-slate-700 hover:border-slate-500'}`
                                     },
                                         React.createElement("div", { className: "flex items-center gap-3" },
                                             React.createElement("div", { className: "w-10 h-10 rounded-full border-2 border-white/20", style: { background: item.color } }),
                                             React.createElement("div", { className: "text-left" },
                                                 React.createElement("div", { className: "font-bold text-sm" }, item.name),
                                                 !owned && React.createElement("div", { className: "text-xs text-yellow-400" }, item.cost + " G")
                                             )
                                         ),
                                         owned ? (equipped ? React.createElement(CheckCircle, { size: 20, className: "text-green-500" }) : null) : React.createElement(Lock, { size: 16, className: "text-slate-600" })
                                     );
                                 })
                             )
                         ),
                         // PET HATS LIST
                         React.createElement("div", { className: "bg-slate-800 rounded-3xl p-6 border border-slate-700 h-fit" },
                             React.createElement("h3", { className: "text-lg font-bold text-slate-400 uppercase tracking-widest mb-4 flex items-center gap-2" }, React.createElement(ChefHat,{size:20}), " Pet Headwear"),
                             React.createElement("div", { className: "flex flex-col gap-3" },
                                 Object.values(PET_HATS).map(item => {
                                     const owned = petHats.includes(item.id);
                                     const equipped = equippedPetHat === item.id;
                                     const isSelected = selectedPetItem?.id === item.id && selectedPetItem?.type === 'hat';

                                     return React.createElement("button", { 
                                         key: item.id, 
                                         onClick: () => {
                                             setPreviewPetHat(item.id);
                                             setSelectedPetItem({ type: 'hat', id: item.id });
                                         },
                                         className: `flex items-center justify-between p-3 rounded-xl border-2 transition-all ${isSelected ? 'bg-slate-700 border-yellow-400 ring-2 ring-yellow-400/30' : 'bg-slate-900 border-slate-700 hover:border-slate-500'}`
                                     },
                                         React.createElement("div", { className: "flex items-center gap-3" },
                                             React.createElement("div", { className: "bg-slate-800 p-2 rounded-lg" }, item.icon || React.createElement(User, {size:20, className: "text-slate-500"})),
                                             React.createElement("div", { className: "text-left" },
                                                 React.createElement("div", { className: "font-bold text-sm" }, item.name),
                                                 !owned && React.createElement("div", { className: "text-xs text-yellow-400" }, item.cost + " G")
                                             )
                                         ),
                                         owned ? (equipped ? React.createElement(CheckCircle, { size: 20, className: "text-green-500" }) : null) : React.createElement(Lock, { size: 16, className: "text-slate-600" })
                                     );
                                 })
                             )
                         )
                     )
                 )
              );
          }

          if (mode === 'game') {
             content = React.createElement("div", { className: `min-h-screen ${currentBg.class} font-sans text-slate-100 flex flex-col relative overflow-hidden ${activeEffectClass}` },
                React.createElement(SvgPatterns),
                React.createElement(Snowfall), // Add Snowfall here
                renderConfetti(),
                renderSparkles(),
                
                // PET COMPONENT (also visible in game for support)
                React.createElement(PetCompanion, {
                    level: petLevel,
                    skinId: equippedPetSkin, // Use equipped state in game
                    hatId: equippedPetHat,
                    onFeed: () => {}, // Cannot feed in game
                    canAffordFeed: false,
                    coins: coins,
                    isHappy: isPetHappy,
                    isEating: isPetEating
                }),

                (levelUp || newUnlock) && React.createElement("div", { className: "absolute inset-0 z-50 flex items-center justify-center pointer-events-none" },
                    React.createElement("div", { className: "bg-white/90 backdrop-blur p-8 rounded-3xl shadow-2xl text-center animate-in zoom-in border-4 border-yellow-400" },
                        React.createElement("div", { className: "text-6xl mb-2" }, newUnlock ? React.createElement(newUnlock.Icon,{size:64,className:"mx-auto text-yellow-500"}) : '⭐'),
                        React.createElement("h2", { className: "text-3xl font-black text-slate-800" }, newUnlock ? 'STICKER UNLOCKED!' : 'LEVEL UP!'),
                        React.createElement("p", { className: "text-xl text-slate-500 font-bold" }, newUnlock ? newUnlock.name : `You are now a ${levelUp.title}!`)
                    )
                ),
                React.createElement("div", { className: "bg-slate-800 p-4 border-b border-slate-700 flex justify-between items-center z-20 shadow-md" },
                    React.createElement("button", { onClick: () => setMode('menu'), className: "text-slate-400 hover:text-white font-bold flex items-center gap-2" }, "← Exit Station"),
                    
                    // Added Music Controls to Game Header
                    React.createElement("div", { className: "flex items-center gap-2 bg-slate-900/50 rounded-xl px-2 border border-slate-700" },
                        React.createElement("button", { onClick: toggleMusic, className: `p-2 transition-all flex items-center gap-2 ${musicEnabled ? 'text-green-400' : 'text-slate-500'}` },
                            musicEnabled ? React.createElement(Volume2, { size: 18 }) : React.createElement(VolumeX, { size: 18 })
                        ),
                        musicEnabled && React.createElement("button", { onClick: nextTrack, className: "p-2 hover:text-white text-slate-400 border-l border-slate-700" }, React.createElement(SkipForward, { size: 16 }))
                    ),

                    React.createElement("div", { className: "flex gap-4" },
                        React.createElement("div", { className: "bg-slate-900 px-4 py-2 rounded-lg border border-slate-600 font-mono text-yellow-400 font-bold flex items-center gap-2" }, React.createElement("span",{className:"text-slate-500"},"$"), coins),
                        React.createElement("div", { className: "bg-slate-900 px-4 py-2 rounded-lg border border-slate-600 font-mono text-orange-400 font-bold flex items-center gap-2" }, React.createElement(Flame,{size:16}), streak)
                    )
                ),
                React.createElement("div", { className: "flex-grow flex flex-col items-center justify-center p-6 w-full max-w-4xl mx-auto" },
                    React.createElement("div", { className: `${currentCounter.class} rounded-3xl shadow-2xl border border-slate-700 w-full min-h-[500px] flex flex-col items-center justify-between p-8 relative overflow-hidden transition-colors duration-500` },
                        React.createElement("div", { className: "flex-grow flex items-center justify-center w-full relative z-10" },
                           renderProblem()
                        ),
                        (currentProblem && !['word-match','comparison','cake-decorator', 'frac-mult-frac'].includes(currentProblem.type)) && React.createElement("div", { className: "w-full pt-8 border-t border-slate-700 mt-8 relative z-20" },
                           !feedback ? React.createElement("div", { className: "flex justify-center gap-4" },
                              React.createElement("input", { type: "text", value: userAnswer, onChange: (e) => setUserAnswer(e.target.value), onKeyDown: (e) => e.key === 'Enter' && checkAnswer(userAnswer), placeholder: "?", className: "bg-slate-900 border-2 border-slate-600 rounded-xl px-6 py-3 text-3xl font-black text-center w-40 focus:border-indigo-500 focus:outline-none text-white", autoFocus: true }),
                              React.createElement("button", { onClick: () => checkAnswer(userAnswer), className: "bg-green-500 hover:bg-green-400 text-white font-bold px-8 rounded-xl shadow-lg border-b-4 border-green-700 active:border-b-0 active:translate-y-1 transition-all" }, "CHECK")
                           ) : React.createElement(FeedbackDisplay, { feedback: feedback, onNext: () => generateProblem(gameType), onRetry: () => setFeedback(null) })
                        ),
                        (currentProblem && (currentProblem.type === 'cake-decorator' || currentProblem.type === 'frac-mult-frac')) && React.createElement("div", { className: "w-full pt-8 border-t border-slate-700 mt-8 relative z-20" },
                           !feedback ? React.createElement("div", { className: "flex justify-center" },
                              React.createElement("button", { onClick: () => checkAnswer(), className: "bg-green-500 hover:bg-green-400 text-white font-bold px-12 py-4 rounded-xl shadow-lg border-b-4 border-green-700 active:border-b-0 active:translate-y-1 transition-all text-xl" }, "Submit Design")
                           ) : React.createElement(FeedbackDisplay, { feedback: feedback, onNext: () => generateProblem(gameType), onRetry: () => setFeedback(null) })
                        ),
                        (currentProblem && ['word-match','comparison'].includes(currentProblem.type) && feedback) && React.createElement("div", { className: "w-full pt-8 border-t border-slate-700 mt-8 relative z-20" },
                           React.createElement(FeedbackDisplay, { feedback: feedback, onNext: () => generateProblem(gameType), onRetry: () => setFeedback(null) })
                        )
                    )
                )
             );
          }

          return React.createElement(React.Fragment, null,
            React.createElement("audio", { ref: audioRef, loop: true }),
            content
          );
        };

        const root = createRoot(document.getElementById('root'));
        root.render(React.createElement(FractionGame));
    </script>
</body>
</html>
